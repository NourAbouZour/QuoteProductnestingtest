<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DXF Filter & Visualizer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6600 0%, #ff8533 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .header-text {
            flex: 1;
        }

        .admin-section {
            margin-left: 20px;
        }

        .admin-btn {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(135deg, #000000 0%, #333333 100%);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .admin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        .main-content {
            padding: 40px;
        }

        .upload-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px dashed #dee2e6;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #ff6600;
            background: #fff5f0;
        }

        .upload-section.dragover {
            border-color: #ff6600;
        }





        .file-input-wrapper {
            text-align: center;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            display: inline-block;
            padding: 15px 30px;
            background: linear-gradient(135deg, #ff6600 0%, #ff8533 100%);
            color: white;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(255, 102, 0, 0.3);
        }

        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 102, 0, 0.4);
        }

        .file-info {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border-left: 4px solid #ff6600;
            display: none;
        }

        /* Parts Status Display Styles */
        .parts-status-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 10px;
        }

        .fitted-parts-section, .unfitted-parts-section {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e0e0e0;
        }

        .fitted-parts-section {
            border-left: 4px solid #4caf50;
        }

        .unfitted-parts-section {
            border-left: 4px solid #f44336;
        }

        .parts-list {
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
        }

        .part-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .part-item:last-child {
            border-bottom: none;
        }

        .part-info {
            flex: 1;
        }

        .part-name {
            font-weight: 600;
            color: #333;
        }

        .part-details {
            color: #666;
            font-size: 11px;
        }

        .part-status {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
        }

        .status-fitted {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .status-unfitted {
            background: #ffebee;
            color: #c62828;
        }

        @media (max-width: 768px) {
            .parts-status-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }

        .processing {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ff6600;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-section {
            display: none;
            margin-top: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            border-top: 4px solid #ff6600;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #ff6600;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
        }

        .image-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .dxf-image {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #dc3545;
            display: none;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #28a745;
            display: none;
        }

        .rules-section {
            background: #fff5f0;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 4px solid #ff6600;
        }

        .rules-section h3 {
            color: #ff6600;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .rules-list {
            list-style: none;
            padding: 0;
        }

        .rules-list li {
            padding: 8px 0;
            border-bottom: 1px solid #b8daff;
            position: relative;
            padding-left: 25px;
        }

        .rules-list li:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: #ff6600;
            font-weight: bold;
        }

        .rules-list li:last-child {
            border-bottom: none;
        }

        .material-selection-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .material-selection-section h3 {
            color: #333;
            font-size: 1.3em;
            margin-bottom: 20px;
            text-align: center;
        }

        /* Material Popup Styles */
        .material-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .material-popup-content {
            background: white;
            border-radius: 15px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .material-popup-header {
            background: linear-gradient(135deg, #ff6600 0%, #ff8533 100%);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .material-popup-header h3 {
            margin: 0;
            font-size: 1.4em;
        }

        .material-popup-close {
            font-size: 2em;
            cursor: pointer;
            font-weight: bold;
            line-height: 1;
        }

        .material-popup-close:hover {
            opacity: 0.8;
        }

        .material-popup-body {
            padding: 25px;
        }

        .material-popup-body p {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.1em;
        }

        .material-popup-parts {
            margin-bottom: 25px;
        }

        .material-popup-part {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .material-popup-part-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .material-popup-part-title {
            font-weight: bold;
            color: #333;
            font-size: 1.1em;
        }

        .material-popup-part-status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .material-popup-part-status.complete {
            background: #d4edda;
            color: #155724;
        }

        .material-popup-part-status.incomplete {
            background: #f8d7da;
            color: #721c24;
        }

        .material-popup-part-fields {
            display: grid;
            grid-template-columns: 160px 1fr 1fr 1fr; /* image + 3 columns of fields */
            gap: 15px;
            align-items: start;
        }
        .material-popup-error {
            grid-column: 1 / -1;
            margin-top: 6px;
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 12px;
        }
        .material-popup-part-image {
            grid-row: 1 / span 2;
            width: 160px;
            height: 160px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .material-popup-part-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .material-popup-field {
            display: flex;
            flex-direction: column;
        }

        .material-popup-field label {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .material-popup-field select {
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            transition: border-color 0.3s ease;
            width: 100%;
        }

        .material-popup-field select:focus {
            outline: none;
            border-color: #ff6600;
        }

        .material-popup-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .material-popup-actions .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .material-popup-actions .btn-primary {
            background: linear-gradient(135deg, #ff6600 0%, #ff8533 100%);
            color: white;
        }

        .material-popup-actions .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 102, 0, 0.3);
        }

        .material-popup-actions .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .material-popup-actions .btn-secondary:hover {
            background: #5a6268;
        }

        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .selection-group {
            display: flex;
            flex-direction: column;
        }

        .selection-group label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .selection-input {
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            transition: border-color 0.3s ease;
        }

        .selection-input:focus {
            outline: none;
            border-color: #ff6600;
        }

        .parts-section {
            margin-top: 30px;
        }

        .parts-header {
            background: #ff6600;
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            text-align: center;
        }

        .parts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .part-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border-top: 4px solid #ff6600;
            transition: all 0.3s ease;
        }

        .part-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .part-card.deleted {
            background-color: #f8d7da;
            opacity: 0.6;
        }

        .part-card.deleted .part-image img {
            filter: grayscale(100%);
        }

        .part-header {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            text-align: center;
        }

        .part-header h4 {
            margin: 0;
            color: #ff6600;
            font-size: 1.2em;
        }

        .part-image {
            padding: 20px;
            text-align: center;
        }

        .part-image img {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .part-stats {
            padding: 15px;
            background: #f8f9fa;
            text-align: center;
            border-top: 1px solid #dee2e6;
        }

        .part-stats .stat-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #ff6600;
        }

        .part-stats .stat-label {
            color: #6c757d;
            font-size: 0.9em;
        }

        .area-info {
            margin-top: 10px;
            text-align: center;
        }

        .area-number {
            font-size: 1.2em;
            font-weight: bold;
            color: #ff6600;
        }

        .area-label {
            color: #6c757d;
            font-size: 0.8em;
        }

        .bending-info {
            margin-top: 10px;
            text-align: center;
        }

        .bending-number {
            font-size: 1.2em;
            font-weight: bold;
            color: #007bff;
        }

        .bending-label {
            color: #6c757d;
            font-size: 0.8em;
        }

        .piece-counter {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }

        .counter-btn {
            width: 32px;
            height: 32px;
            border: 2px solid #ff6600;
            background: white;
            color: #ff6600;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            touch-action: manipulation;
        }

        .counter-btn:hover {
            background: #ff6600;
            color: white;
            transform: scale(1.1);
        }

        .counter-btn:active {
            transform: scale(0.95);
        }

        .counter-btn.long-press {
            background: #4CAF50 !important;
            border-color: #4CAF50 !important;
            color: white !important;
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
        }

        .counter-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .piece-count {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            min-width: 30px;
            text-align: center;
        }

        .part-cost {
            text-align: center;
            padding: 10px;
            background: #fff2e6;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .unit-cost {
            font-size: 1.0em;
            font-weight: 500;
            color: #666;
            margin-bottom: 5px;
        }
        
        .total-cost {
            font-size: 1.2em;
            font-weight: bold;
            color: #28a745;
        }

        .unit-cost.deleted,
        .total-cost.deleted {
            color: #dc3545;
            text-decoration: line-through;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 15px 0;
        }

        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 60px;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
        }

        .delete-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .revoke-btn {
            background: #28a745;
            color: white;
        }

        .revoke-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .total-area-section {
            background: linear-gradient(135deg, #ff6600 0%, #ff8533 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-top: 30px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(255, 102, 0, 0.3);
        }

        .total-area-section h3 {
            margin: 0 0 10px 0;
            font-size: 1.5em;
            font-weight: 300;
        }

        .total-area-number {
            font-size: 3em;
            font-weight: bold;
            margin: 10px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .total-area-description {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .cost-section {
            background: linear-gradient(135deg, #000000 0%, #333333 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-top: 30px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .cost-section h3 {
            margin: 0 0 10px 0;
            font-size: 1.5em;
            font-weight: 300;
        }

        .cost-number {
            font-size: 3em;
            font-weight: bold;
            margin: 10px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .cost-description {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .cost-breakdown {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
        }

        .cost-breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 1.1em;
            flex-direction: column;
        }

        .cost-breakdown-item.total {
            font-size: 1.3em;
            font-weight: bold;
            border-top: 2px solid rgba(255, 255, 255, 0.3);
            margin-top: 10px;
            padding-top: 15px;
        }

        .cost-breakdown-label {
            color: rgba(255, 255, 255, 0.9);
        }

        .pdf-section {
            background: linear-gradient(135deg, #000000 0%, #333333 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-top: 30px;
            text-align: center;
            box-shadow: 0 5px 15px  linear-gradient(135deg, #000000 0%, #333333 100%);
        }

        .pdf-actions {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        .pdf-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px  linear-gradient(135deg, #000000 0%, #333333 100%);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pdf-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px whitesmoke;
            background:  linear-gradient(135deg, #000000 0%, #333333 100%);
        }

        .pdf-btn:active {
            transform: translateY(0);
        }

        .pdf-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .modal-header h2 {
            color: #000000;
            margin: 0;
            font-size: 1.8em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .form-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            background-color: white;
            transition: border-color 0.3s ease;
        }

        .modal-buttons {
            text-align: center;
            margin-top: 30px;
        }

        .modal-btn {
            padding: 12px 30px;
            margin: 0 10px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, #000000 0%, #333333 100%);
            color: white;
        }

        .modal-btn-primary:hover {
            background: linear-gradient(135deg, #000000 0%, #333333 100%);
            transform: translateY(-2px);
        }

        .modal-btn-secondary {
            background: #6c757d;
            color: white;
        }

        .modal-btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .required {
            color: #dc3545;
        }

        .cost-breakdown-value {
            font-weight: 600;
            color: #ffffff;
        }

        .cost-breakdown-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.2);
            margin: 10px 0;
        }

        .part-cost-info {
            background: #fff5f0;
            border: 1px solid #ffcc99;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            text-align: left;
        }

        .part-cost-info h4 {
            color: #ff6600;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .cost-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            font-size: 0.9em;
        }

        .cost-detail {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }

        .cost-label {
            color: #ff6600;
            font-weight: 500;
        }

        .cost-value {
            color: #000000;
            font-weight: 600;
        }

        /* Error display styles */
        .part-cost-info.has-error {
            background: #fff5f5;
            border-color: #ff6b6b;
        }

        .part-cost-info.has-error h4 {
            color: #dc3545;
        }

        .calculation-error {
            color: #721c24;
        }
        
        .help-tips {
            background-color: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 6px;
            padding: 12px;
            margin-top: 12px;
        }
        
        .help-tips h5 {
            color: #0369a1;
            margin: 0 0 8px 0;
            font-size: 14px;
        }
        
        .help-tips ul {
            margin: 8px 0;
            padding-left: 20px;
        }
        
        .help-tips li {
            margin: 4px 0;
            font-size: 13px;
            color: #1e40af;
        }
        
        .help-tips p {
            margin: 8px 0 4px 0;
            font-weight: 600;
            color: #1e40af;
        }
        
        .dxf-help-tips {
            background-color: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 6px;
            padding: 12px;
            margin: 12px 0;
        }
        
        .dxf-help-tips h5 {
            color: #0369a1;
            margin: 0 0 8px 0;
            font-size: 14px;
        }
        
        .dxf-help-tips p {
            margin: 6px 0;
            color: #1e40af;
            font-size: 13px;
        }
        
        .dxf-help-tips .label-examples {
            margin: 8px 0;
        }
        
        .dxf-help-tips .label-examples strong {
            color: #1e40af;
        }
        
        .dxf-help-tips .label-examples ul {
            margin: 6px 0;
            padding-left: 20px;
        }
        
        .dxf-help-tips .label-examples li {
            margin: 3px 0;
            color: #1e40af;
            font-size: 12px;
        }
        
        .dxf-help-tips .label-examples code {
            background-color: #e0f2fe;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
            color: #0c4a6e;
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .error-details {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
        }

        .error-details p {
            margin: 8px 0;
            color: #495057;
            font-size: 0.9em;
            line-height: 1.4;
        }

        /* Error summary styles */
        .error-summary {
            background: #fff5f5;
            border: 2px solid #ff6b6b;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .error-summary-header h3 {
            color: #dc3545;
            margin: 0 0 15px 0;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .error-summary-content p {
            margin: 10px 0;
            color: #495057;
            font-size: 0.95em;
            line-height: 1.5;
        }

        .error-summary-content ul {
            margin: 15px 0;
            padding-left: 20px;
        }

        .error-summary-content li {
            margin: 8px 0;
            color: #721c24;
            font-weight: 500;
        }

        .error-summary-note {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            margin-top: 15px;
            font-style: italic;
        }

        /* Excluded parts note styling */
        #excludedPartsNote,
        #excludedPartsNote2 {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 5px 0;
        }

        #excludedPartsNote .cost-breakdown-label,
        #excludedPartsNote2 .cost-breakdown-label {
            color: #856404;
            font-weight: 600;
        }

        #excludedPartsNote .cost-breakdown-value,
        #excludedPartsNote2 .cost-breakdown-value {
            color: #856404;
            font-weight: 600;
        }

        .external-services-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .external-services-section h3 {
            color: #333;
            font-size: 1.3em;
            margin-bottom: 15px;
            text-align: center;
        }

        .services-description {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 20px;
            text-align: center;
        }

        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .service-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid #e9ecef;
        }

        .service-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .service-checkbox-input {
            width: 20px;
            height: 20px;
            accent-color: #ff6600;
        }

        .service-label {
            font-weight: 600;
            color: #333;
            font-size: 1em;
        }

        .service-inputs {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            flex-grow: 1;
        }

        .service-quantity,
        .service-price {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            width: 100px;
            text-align: center;
        }

        .service-quantity:focus,
        .service-price:focus {
            outline: none;
            border-color: #ff6600;
        }

        .service-total {
            font-weight: 600;
            color: #28a745;
            font-size: 1.1em;
        }

        .services-summary {
            border-top: 1px solid #dee2e6;
            padding-top: 15px;
            margin-top: 20px;
            text-align: right;
        }

        .services-total {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }

        .services-total-label {
            margin-right: 10px;
        }

        .services-total-amount {
            color: #ff6600;
        }

        /* Processing centered under upload */
        .processing {
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 8px;
            margin-top: 14px;
            text-align: center;
        }
        .processing .spinner { margin: 0 auto; }

        .scrap-factor-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid #e1e5e9;
        }

        .scrap-factor-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        /* Centered scrap controls */
        .scrap-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            margin-top: 8px;
        }
        .scrap-row {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }
        .scrap-field {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }
        .scrap-field label { font-weight: 600; color: #333; }
        .scrap-field input {
            padding: 10px 14px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            width: 160px;
            text-align: center;
            transition: border-color 0.2s ease;
        }
        .scrap-field input:focus { outline: none; border-color: #ff6600; }
        .scrap-field input::placeholder { color: #9aa2a8; font-style: italic; }

        .scrap-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .scrap-btn {
            background: #ff6600;
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 10px 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s ease;
            box-shadow: 0 2px 8px rgba(255,102,0,0.2);
        }
        .scrap-btn:hover { background: #e65a00; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(255,102,0,0.3); }
        .scrap-btn:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; transform: none; }

        /* Quantity input styling */
        .piece-counter { display: flex; gap: 8px; align-items: center; justify-content: center; }
        .piece-input {
            width: 66px; padding: 8px 10px; border: 2px solid #e1e5e9; border-radius: 8px; text-align: center; font-weight: 600; font-size: 15px;
        }
        .piece-input:focus { outline: none; border-color: #ff6600; }

        .scrap-input-group {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .scrap-input-group label {
            font-weight: 600;
            color: #333;
            min-width: 120px;
        }

        .scrap-input {
            padding: 10px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            width: 120px;
            transition: border-color 0.3s ease;
        }

        .scrap-input:focus {
            outline: none;
            border-color: #ff6600;
        }

        .scrap-description {
            color: #666;
            font-size: 0.9em;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }

            .main-content {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .parts-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .part-card {
                margin: 0 10px;
            }

            .part-image img {
                max-height: 200px;
            }

            .counter-btn {
                width: 28px;
                height: 28px;
                font-size: 14px;
            }

            .action-btn {
                padding: 6px 8px;
                font-size: 0.7em;
                min-width: 50px;
            }

            .services-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .service-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .service-inputs {
                width: 100%;
                justify-content: space-between;
            }

            .service-quantity,
            .service-price {
                width: 80px;
                font-size: 12px;
            }

            .cost-breakdown {
                padding: 15px;
            }

            .cost-breakdown-item {
                font-size: 1em;
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            .cost-breakdown-item.total {
                font-size: 1.2em;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        /* Multi-file controls (under upload) */
        #uploadSection {
            background: #fff8f6;
            border: 1px solid #f0e0db;
            border-radius: 12px;
            padding: 14px;
        }
        #multiFilesControls {
            margin-top: 12px;
            background: #fff;
            border: 1px dashed #e5e5e5;
            border-radius: 10px;
            padding: 12px;
        }
        #addMultiFilesBtn {
            background: #343a40;
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
        }
        #addMultiFilesBtn:hover { background: #23272b; }
        #processMultiBtn {
            background: linear-gradient(135deg, #000000 0%, #333333 100%);;
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
        }
        #processMultiBtn:hover { background: linear-gradient(135deg, #000000 0%, #333333 100%); }
        #multiFilesList > .mf-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border: 1px solid #eee;
            background: #fcfcfc;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .mf-item .mf-info {
            font-size: 0.95rem;
            color: #333;
        }
        .mf-item .mf-actions .btn {
            background:linear-gradient(135deg, #000000 0%, #333333 100%);;
            color: #fff;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 6px;
        }
        .mf-item .mf-actions .btn:hover { background: #5a6268; }
        .mf-item .mf-actions .btn.mf-remove { background: #dc3545; }
        .mf-item .mf-actions .btn.mf-remove:hover { background: #c82333; }
    </style>
</head>
<body>
    <!-- PDF Input Modal -->
    <div id="pdfModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📄 PDF Quote Details</h2>
                <p>Please enter the quotation details below</p>
            </div>
            <form id="pdfForm">
                <div class="form-group">
                    <label for="quotationNumber">Quotation Number <span class="required">*</span></label>
                    <input type="text" id="quotationNumber" name="quotationNumber" required>
                </div>
                <div class="form-group">
                    <label for="quotationDate">Quotation Date</label>
                    <input type="date" id="quotationDate" name="quotationDate" readonly>
                </div>
                <div class="form-group">
                    <label for="companyName">Company Name <span class="required">*</span></label>
                    <input type="text" id="companyName" name="companyName" required>
                </div>
                <div class="form-group">
                    <label for="pscNumber">PSC Number <span class="required">*</span></label>
                    <input type="text" id="pscNumber" name="pscNumber" required>
                </div>
                <div class="form-group">
                    <label for="vatId">VAT ID</label>
                    <input type="text" id="vatId" name="vatId" placeholder="Optional">
                </div>
                <div class="form-group">
                    <label for="contactName">Contact Name <span class="required">*</span></label>
                    <input type="text" id="contactName" name="contactName" required>
                </div>
                <div class="form-group">
                    <label for="telephone">Telephone <span class="required">*</span></label>
                    <input type="tel" id="telephone" name="telephone" required>
                </div>
                <div class="form-group">
                    <label for="email">Email <span class="required">*</span></label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="address">Address <span class="required">*</span></label>
                    <input type="text" id="address" name="address" required>
                </div>
                <div class="form-group">
                    <label for="paymentTerms">Payment Terms</label>
                    <select id="paymentTerms" name="paymentTerms" class="form-select">
                        <option value="">Select Payment Terms</option>
                        <option value="Cash by USD banknotes">Cash by USD banknotes</option>
                        <option value="To be agreed on">To be agreed on</option>
                        <option value="50% on order confirmation; Balance on delivery">50% on order confirmation; Balance on delivery</option>
                        <option value="100% on order confirmation">100% on order confirmation</option>
                        <option value="1/3 on delivery; 1/3 after 30 days; 1/3 after 60 days">1/3 on delivery; 1/3 after 30 days; 1/3 after 60 days</option>
                        <option value="35% on confirmation; 35% on delivery; Balance 30 days after">35% on confirmation; 35% on delivery; Balance 30 days after</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="deliveryMethod">Delivery Method</label>
                    <select id="deliveryMethod" name="deliveryMethod" class="form-select">
                        <option value="">Select Delivery Method</option>
                        <option value="By your truck">By your truck</option>
                        <option value="By Naggiar truck">By Naggiar truck</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="deliveryPlace">Can we postpone the delivery place for now?</label>
                    <select id="deliveryPlace" name="deliveryPlace" class="form-select">
                        <option value="">Select Delivery Place</option>
                        <option value="Naggiar Nahr">Naggiar Nahr</option>
                        <option value="Naggiar Saifi">Naggiar Saifi</option>
                        <option value="Naggiar Zahle">Naggiar Zahle</option>
                        <option value="Naggiar Ghazieh">Naggiar Ghazieh</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="deliveryDate">Delivery date is the process time?</label>
                    <select id="deliveryDate" name="deliveryDate" class="form-select">
                        <option value="">Select Delivery Date</option>
                        <option value="To be agreed on">To be agreed on</option>
                        <option value="Within 3 working days, from order confirmation">Within 3 working days, from order confirmation</option>
                        <option value="Within 4 working days, from order confirmation">Within 4 working days, from order confirmation</option>
                        <option value="Within 5 working days, from order confirmation">Within 5 working days, from order confirmation</option>
                        <option value="Within 7 working days, from order confirmation">Within 7 working days, from order confirmation</option>
                        <option value="10 working days, from order confirmation">10 working days, from order confirmation</option>
                        <option value="15 working days, from order confirmation">15 working days, from order confirmation</option>
                        <option value="20 working days, from order confirmation">20 working days, from order confirmation</option>
                        <option value="25 working days, from order confirmation">25 working days, from order confirmation</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="validity">Validity</label>
                    <select id="validity" name="validity" class="form-select">
                        <option value="">Select Validity</option>
                        <option value="1 working day">1 working day</option>
                        <option value="2 working days">2 working days</option>
                        <option value="3 working days">3 working days</option>
                        <option value="5 working days">5 working days</option>
                        <option value="10 working days">10 working days</option>
                        <option value="To be agreed on">To be agreed on</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="modal-btn modal-btn-secondary" onclick="closePdfModal()">Cancel</button>
                    <button type="submit" class="modal-btn modal-btn-primary">Generate PDF</button>
                </div>
                <!-- PDF generation progress bar (shown under the Generate PDF button) -->
                <div id="pdfProgressContainer" style="display:none; width:100%; height:14px; background:#eee; border-radius:7px; overflow:hidden; margin-top:10px; position:relative;">
                    <div id="pdfProgressBar" style="height:100%; width:0%; background:#4caf50; transition:width 0.2s ease;"></div>
                    <div id="pdfProgressLabel" style="position:absolute; top:0; left:0; right:0; height:100%; display:flex; align-items:center; justify-content:center; font-size:12px; color:#000;">0%</div>
                </div>
            </form>
        </div>
    </div>

    <!-- Per-File Material Edit Modal -->
    <div id="fileMaterialModal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🧩 Edit File Material</h2>
                <p>Select material settings for this file</p>
            </div>
            <div class="form-group">
                <label for="fmMaterialTypeSelect">Material Name</label>
                <select id="fmMaterialTypeSelect" class="form-select">
                    <option value="">Loading…</option>
                </select>
            </div>
            <div class="form-group">
                <label for="fmThicknessSelect">Thickness</label>
                <select id="fmThicknessSelect" class="form-select">
                    <option value="">Select Material First</option>
                </select>
            </div>
            <div class="form-group">
                <label for="fmGradeSelect">Grade</label>
                <select id="fmGradeSelect" class="form-select">
                    <option value="">Select Thickness First</option>
                </select>
            </div>
            <div class="form-group">
                <label for="fmFinishSelect">Finish</label>
                <select id="fmFinishSelect" class="form-select">
                    <option value="">Select Grade First</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button type="button" class="modal-btn modal-btn-secondary" onclick="closeFileMaterialModal()">Cancel</button>
                <button type="button" class="modal-btn modal-btn-primary" onclick="saveFileMaterialModal()">Save</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-text">
                    <h1>DXF Filter & Visualizer</h1>
                    <!-- <p>Upload your DXF file and see the filtered results according to your specifications</p> -->
                    {% if user_data %}
                    <p style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">
                        Welcome, {{ user_data.full_name }} ({{ user_data.email }})
                    </p>
                    {% endif %}
                </div>
                <div class="admin-section">
                    {% if user_data %}
                    <a href="{{ url_for('user_logout') }}" class="admin-btn">Logout</a>
                    {% else %}
                    <a href="{{ url_for('user_login') }}" class="admin-btn">Login</a>
                    {% endif %}
                    <a href="{{ url_for('admin_login') }}" class="admin-btn" style="margin-left: 10px;">Admin</a>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- <div class="rules-section">
                <h3>Filtering Rules Applied:</h3>
                <ul class="rules-list">
                    <li><strong>Remove:</strong> Red lines (DIMENSION layer - dimensions and leaders)</li>
                    <li><strong>Remove:</strong> White "SECTIONS" layer</li>
                    <li><strong>Keep:</strong> White "0" layer (displayed as white lines)</li>
                    <li><strong>Keep:</strong> Green "V-GROOVE" entities (displayed as green lines)</li>
                </ul>
            </div> -->

            <!-- Material selection section is now hidden and will appear as popup when needed -->
            <div class="material-selection-section" id="materialSelectionSection" style="display: none;">
                <h3>🔧 Material Selection</h3>
                <div class="selection-grid">
                    <div class="selection-group">
                        <label for="materialTypeSelect">Material Type:</label>
                        <select id="materialTypeSelect" name="material_type" class="selection-input">
                            <option value="">Loading...</option>
                        </select>
                    </div>
                    <div class="selection-group">
                        <label for="thicknessSelect">Thickness:</label>
                        <select id="thicknessSelect" name="thickness" class="selection-input">
                            <option value="">Select Material Type First</option>
                        </select>
                    </div>
                    <div class="selection-group">
                        <label for="gradeSelect">Grade:</label>
                        <select id="gradeSelect" name="grade" class="selection-input">
                            <option value="">Select Material Type First</option>
                        </select>
                    </div>
                    <div class="selection-group">
                        <label for="finishSelect">Finish:</label>
                        <select id="finishSelect" name="finish" class="selection-input">
                            <option value="">Select Material Type First</option>
                        </select>
                    </div>
                </div>
                
            </div>

            <!-- Material Selection Popup -->
            <div id="materialPopup" class="material-popup" style="display: none;">
                <div class="material-popup-content">
                    <div class="material-popup-header">
                        <h3>🔧 Material Selection Required</h3>
                       
                    </div>
                    <div class="material-popup-body">
                        <p>Some parts in your DXF file are missing material information. Please select the materials for these parts:</p>
                        <div id="materialPopupParts" class="material-popup-parts">
                            <!-- Parts will be populated here -->
                        </div>
                        <div class="material-popup-actions">
                            <button type="button" class="btn btn-primary" onclick="applyMaterialSelections()">Continue</button>
                          
                        </div>
                    </div>
                </div>
            </div>

            <div class="upload-section" id="uploadSection">
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" class="file-input" accept=".dxf" multiple>
                    <label for="fileInput" class="file-input-label">
                        📁 Choose DXF File
                    </label>
                </div>
                <div class="file-info" id="fileInfo"></div>
                
                <!-- Helpful tips for DXF labeling -->
                <!-- <div class="dxf-help-tips">
                    <h5>💡 DXF File Labeling Tips</h5>
                    <p>For best results, add material labels below each part in your DXF file:</p>
                    <div class="label-examples">
                        <strong>Examples:</strong>
                        <ul>
                            <li><code>Brass 1mm</code> - for brass parts</li>
                            <li><code>Aluminum 2mm</code> - for aluminum parts</li>
                            <li><code>SS304 1.2mm</code> - for stainless steel</li>
                            <li><code>Copper 0.5mm</code> - for copper parts</li>
                        </ul>
                    </div>
                    <p><strong>Note:</strong> If labels are missing, you can still select materials in the form below.</p>
                </div> -->
                
                <div class="multi-files-controls" id="multiFilesControls" style="margin-top:12px; display:none;">
                    <button type="button" id="addMultiFilesBtn" class="btn">Add DXF Files</button>
                    <input type="file" id="multiFilesInput" accept=".dxf" multiple style="display:none">
                    <div id="multiFilesList" style="margin-top:10px"></div>
                    <button type="button" id="processMultiBtn" class="btn" style="margin-top:8px; display:none;">Process Quotation (Multiple Files)</button>
                </div>
            </div>



            <div class="scrap-factor-section">
                <h3>🔧 SCRAP Factor</h3>
                <div class="scrap-input-group">
                    <label for="scrapFactor">SCRAP Factor:</label>
                    <input type="number" id="scrapFactor" name="scrap_factor" value="1.20" step="0.01" min="0.01" class="scrap-input">
                    <!-- <span class="scrap-description">Default: 1.20 (used for material cost calculation)</span> -->
                </div>

                <!-- Board controls -->
                <div class="scrap-center">
                    <!-- <div class="scrap-row">
                        <div class="scrap-field">
                            <label for="nestGap">Min Part Gap (mm)</label>
                            <input type="number" id="nestGap" placeholder="e.g. 5" value="5" min="0" step="0.5">
                        </div>
                        <div class="scrap-field">
                            <label for="marginAll">Sheet Margin (mm)</label>
                            <input type="number" id="marginAll" placeholder="e.g. 10" value="10" min="0" step="0.5">
                        </div>
                    </div> -->
                    <div class="scrap-actions">
                        <button type="button" class="scrap-btn" id="calcQuoteBtn" onclick="calculateQuote()">Calculate Quote</button>
                        <!-- <button type="button" class="scrap-btn" id="nestMetricsBtn">Nest &amp; Calculate Scrap</button> -->
                    </div>
                </div>
                
                <!-- Parts status display removed - will be replaced with new implementation -->
            </div>

            <div class="external-services-section">
                <h3>🔧 External Services</h3>
                <p class="services-description">Select additional services and specify quantities and prices:</p>
                <div class="services-grid" id="servicesGrid">
                    <div class="service-item">
                        <div class="service-checkbox">
                            <input type="checkbox" id="punching" class="service-checkbox-input">
                            <label for="punching" class="service-label">Punching</label>
                        </div>
                        <div class="service-inputs" style="display: none;">
                            <input type="number" class="service-quantity" placeholder="Qty" min="0" step="1">
                            <input type="number" class="service-price" placeholder="Price" min="0" step="0.01">
                            <span class="service-total">$0.00</span>
                        </div>
                    </div>
                    <div class="service-item">
                        <div class="service-checkbox">
                            <input type="checkbox" id="brushing" class="service-checkbox-input">
                            <label for="brushing" class="service-label">Brushing</label>
                        </div>
                        <div class="service-inputs" style="display: none;">
                            <input type="number" class="service-quantity" placeholder="Qty" min="0" step="1">
                            <input type="number" class="service-price" placeholder="Price" min="0" step="0.01">
                            <span class="service-total">$0.00</span>
                        </div>
                    </div>
                    <div class="service-item">
                        <div class="service-checkbox">
                            <input type="checkbox" id="marking" class="service-checkbox-input">
                            <label for="marking" class="service-label">Marking</label>
                        </div>
                        <div class="service-inputs" style="display: none;">
                            <input type="number" class="service-quantity" placeholder="Qty" min="0" step="1">
                            <input type="number" class="service-price" placeholder="Price" min="0" step="0.01">
                            <span class="service-total">$0.00</span>
                        </div>
                    </div>
                    <div class="service-item">
                        <div class="service-checkbox">
                            <input type="checkbox" id="uv_print" class="service-checkbox-input">
                            <label for="uv_print" class="service-label">UV Print</label>
                        </div>
                        <div class="service-inputs" style="display: none;">
                            <input type="number" class="service-quantity" placeholder="Qty" min="0" step="1">
                            <input type="number" class="service-price" placeholder="Price" min="0" step="0.01">
                            <span class="service-total">$0.00</span>
                        </div>
                    </div>
                    <div class="service-item">
                        <div class="service-checkbox">
                            <input type="checkbox" id="cutting" class="service-checkbox-input">
                            <label for="cutting" class="service-label">Cutting</label>
                        </div>
                        <div class="service-inputs" style="display: none;">
                            <input type="number" class="service-quantity" placeholder="Qty" min="0" step="1">
                            <input type="number" class="service-price" placeholder="Price" min="0" step="0.01">
                            <span class="service-total">$0.00</span>
                        </div>
                    </div>
                    <div class="service-item">
                        <div class="service-checkbox">
                            <input type="checkbox" id="pvc_cover" class="service-checkbox-input">
                            <label for="pvc_cover" class="service-label">PVC Cover</label>
                        </div>
                        <div class="service-inputs" style="display: none;">
                            <input type="number" class="service-quantity" placeholder="Qty" min="0" step="1">
                            <input type="number" class="service-price" placeholder="Price" min="0" step="0.01">
                            <span class="service-total">$0.00</span>
                        </div>
                    </div>
                    <div class="service-item">
                        <div class="service-checkbox">
                            <input type="checkbox" id="rolling" class="service-checkbox-input">
                            <label for="rolling" class="service-label">Rolling</label>
                        </div>
                        <div class="service-inputs" style="display: none;">
                            <input type="number" class="service-quantity" placeholder="Qty" min="0" step="1">
                            <input type="number" class="service-price" placeholder="Price" min="0" step="0.01">
                            <span class="service-total">$0.00</span>
                        </div>
                    </div>
                    <div class="service-item">
                        <div class="service-checkbox">
                            <input type="checkbox" id="straighten" class="service-checkbox-input">
                            <label for="straighten" class="service-label">Straighten</label>
                        </div>
                        <div class="service-inputs" style="display: none;">
                            <input type="number" class="service-quantity" placeholder="Qty" min="0" step="1">
                            <input type="number" class="service-price" placeholder="Price" min="0" step="0.01">
                            <span class="service-total">$0.00</span>
                        </div>
                    </div>
                    <div class="service-item">
                        <div class="service-checkbox">
                            <input type="checkbox" id="cornerform" class="service-checkbox-input">
                            <label for="cornerform" class="service-label">Corner Form</label>
                        </div>
                        <div class="service-inputs" style="display: none;">
                            <input type="number" class="service-quantity" placeholder="Qty" min="0" step="1">
                            <input type="number" class="service-price" placeholder="Price" min="0" step="0.01">
                            <span class="service-total">$0.00</span>
                        </div>
                    </div>
                    <div class="service-item">
                        <div class="service-checkbox">
                            <input type="checkbox" id="router" class="service-checkbox-input">
                            <label for="router" class="service-label">Router</label>
                        </div>
                        <div class="service-inputs" style="display: none;">
                            <input type="number" class="service-quantity" placeholder="Qty" min="0" step="1">
                            <input type="number" class="service-price" placeholder="Price" min="0" step="0.01">
                            <span class="service-total">$0.00</span>
                        </div>
                    </div>
                    <div class="service-item">
                        <div class="service-checkbox">
                            <input type="checkbox" id="finishing" class="service-checkbox-input">
                            <label for="finishing" class="service-label">Finishing</label>
                        </div>
                        <div class="service-inputs" style="display: none;">
                            <input type="number" class="service-quantity" placeholder="Qty" min="0" step="1">
                            <input type="number" class="service-price" placeholder="Price" min="0" step="0.01">
                            <span class="service-total">$0.00</span>
                        </div>
                    </div>
                    <div class="service-item">
                        <div class="service-checkbox">
                            <input type="checkbox" id="installing" class="service-checkbox-input">
                            <label for="installing" class="service-label">Installing</label>
                        </div>
                        <div class="service-inputs" style="display: none;">
                            <input type="number" class="service-quantity" placeholder="Qty" min="0" step="1">
                            <input type="number" class="service-price" placeholder="Price" min="0" step="0.01">
                            <span class="service-total">$0.00</span>
                        </div>
                    </div>
                    <div class="service-item">
                        <div class="service-checkbox">
                            <input type="checkbox" id="other" class="service-checkbox-input">
                            <label for="other" class="service-label">Other</label>
                        </div>
                        <div class="service-inputs" style="display: none;">
                            <input type="number" class="service-quantity" placeholder="Qty" min="0" step="1">
                            <input type="number" class="service-price" placeholder="Price" min="0" step="0.01">
                            <span class="service-total">$0.00</span>
                        </div>
                    </div>
                </div>
                <div class="services-summary">
                    <div class="services-total">
                        <span class="services-total-label">External Services Total:</span>
                        <span class="services-total-amount" id="externalServicesTotal">$0.00</span>
                    </div>
                </div>
            </div>


            <div class="processing" id="processing">
                <div class="spinner"></div>
                <p id="processingText">Processing DXF file...</p>
                <div id="progressContainer" style="display:none; width:100%; max-width:480px; height:14px; background:#eee; border-radius:8px; overflow:hidden; margin-top:8px; position:relative;">
                    <div id="progressBar" style="height:100%; width:0%; background:#4caf50; transition:width 0.2s ease;"></div>
                    <div id="progressLabel" style="position:absolute; top:0; left:0; right:0; height:100%; display:flex; align-items:center; justify-content:center; font-size:12px; color:#333;">0%</div>
                </div>
            </div>

            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>

            <div class="results-section" id="resultsSection" style="display:none">
                <div class="stats-grid" id="statsGrid"></div>
                <div class="image-container" style="margin-bottom:16px;">
                    <img id="dxfImage" class="dxf-image" alt="Filtered DXF Visualization">
                </div>
            </div>

            <!-- Container to hold results for multiple files -->
            <div id="resultsList"></div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const processing = document.getElementById('processing');
        const resultsSection = document.getElementById('resultsSection');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const statsGrid = document.getElementById('statsGrid');
        const dxfImage = document.getElementById('dxfImage');
        const uploadSection = document.getElementById('uploadSection');
        const servicesGrid = document.getElementById('servicesGrid');
        const externalServicesTotal = document.getElementById('externalServicesTotal');

        // Helper functions for part dimensions
        function calculatePartLength(areaSqMm, lengthMm = null) {
            // Use actual length if provided, otherwise fallback to square root of area
            if (lengthMm !== null && lengthMm > 0) {
                return lengthMm;
            }
            // Fallback: Assume square root of area for length (simplified calculation)
            return Math.sqrt(areaSqMm);
        }

        function calculatePartWidth(areaSqMm, widthMm = null) {
            // Use actual width if provided, otherwise fallback to square root of area
            if (widthMm !== null && widthMm > 0) {
                return widthMm;
            }
            // Fallback: Assume square root of area for width (simplified calculation)
            return Math.sqrt(areaSqMm);
        }

        // External services functionality
        function initializeExternalServices() {
            // Add event listeners to all checkboxes
            document.querySelectorAll('.service-checkbox-input').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const serviceItem = this.closest('.service-item');
                    const inputs = serviceItem.querySelector('.service-inputs');
                    
                    if (this.checked) {
                        inputs.style.display = 'flex';
                        // Reset inputs when showing
                        const quantityInput = inputs.querySelector('.service-quantity');
                        const priceInput = inputs.querySelector('.service-price');
                        quantityInput.value = '';
                        priceInput.value = '';
                        updateServiceTotal(serviceItem);
                    } else {
                        inputs.style.display = 'none';
                        // Clear inputs when hiding
                        const quantityInput = inputs.querySelector('.service-quantity');
                        const priceInput = inputs.querySelector('.service-price');
                        quantityInput.value = '';
                        priceInput.value = '';
                        updateServiceTotal(serviceItem);
                    }
                    updateExternalServicesTotal();
                });
            });

            // Add event listeners to quantity and price inputs
            document.querySelectorAll('.service-quantity, .service-price').forEach(input => {
                input.addEventListener('input', function() {
                    const serviceItem = this.closest('.service-item');
                    updateServiceTotal(serviceItem);
                    updateExternalServicesTotal();
                });
            });
        }

        // Nesting functionality removed for deployment

        // Record last single-file upload params to allow reprice
        window.__lastUploadParams = { single: false };


        function updateServiceTotal(serviceItem) {
            const quantityInput = serviceItem.querySelector('.service-quantity');
            const priceInput = serviceItem.querySelector('.service-price');
            const totalSpan = serviceItem.querySelector('.service-total');
            
            const quantity = parseFloat(quantityInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const total = quantity * price;
            
            totalSpan.textContent = `$${total.toFixed(2)}`;
        }

        function updateExternalServicesTotal() {
            let total = 0;
            let checkedServices = 0;
            const servicesBreakdown = [];
            
            document.querySelectorAll('.service-checkbox-input:checked').forEach(checkbox => {
                checkedServices++;
                const serviceItem = checkbox.closest('.service-item');
                const quantityInput = serviceItem.querySelector('.service-quantity');
                const priceInput = serviceItem.querySelector('.service-price');
                
                const quantity = parseFloat(quantityInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                const serviceTotal = quantity * price;
                total += serviceTotal;
                
                if (serviceTotal > 0) {
                    servicesBreakdown.push({
                        name: checkbox.id,
                        total: serviceTotal
                    });
                }
                
                // Debug log suppressed
            });
            
            // Debug log suppressed
            
            // Update the external services total in the services section
            const externalServicesTotalEl = document.getElementById('externalServicesTotal');
            if (externalServicesTotalEl) externalServicesTotalEl.textContent = `$${total.toFixed(2)}`;
            
            // Update the external services breakdown in the cost breakdown
            const externalServicesBreakdownEl = document.getElementById('externalServicesBreakdown');
            if (externalServicesBreakdownEl) {
                if (servicesBreakdown.length > 0) {
                    externalServicesBreakdownEl.innerHTML = servicesBreakdown.map(service => 
                        `<div class="cost-breakdown-item">
                            <span class="cost-breakdown-label">Add ${service.name.charAt(0).toUpperCase() + service.name.slice(1)}:</span>
                            <span class="cost-breakdown-value">$${service.total.toFixed(2)}</span>
                        </div>`
                    ).join('');
                } else {
                    externalServicesBreakdownEl.innerHTML = '';
                }
            }
            
            // Update the main total cost when external services change
            if (window.currentData) {
                updateTotalCost();
            }
        }

        function getExternalServicesData() {
            const servicesData = {};
            document.querySelectorAll('.service-checkbox-input:checked').forEach(checkbox => {
                const serviceName = checkbox.id;
                const serviceItem = checkbox.closest('.service-item');
                const quantityInput = serviceItem.querySelector('.service-quantity');
                const priceInput = serviceItem.querySelector('.service-price');
                
                const quantity = parseFloat(quantityInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                const total = quantity * price;
                
                if (total > 0) {
                    servicesData[serviceName] = {
                        quantity: quantity,
                        price: price,
                        total: total
                    };
                }
            });
            return servicesData;
        }

        function getPartQuantities() {
            const partQuantities = {};
            document.querySelectorAll('.part-card').forEach(partCard => {
                const partNumber = partCard.getAttribute('data-part');
                const qtyInput = partCard.querySelector('input.piece-input');
                if (qtyInput && partNumber) {
                    const quantity = parseInt(qtyInput.value || qtyInput.placeholder || '1') || 1;
                    partQuantities[partNumber] = quantity;
                }
            });
            return partQuantities;
        }

        // Drag and drop functionality
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', async (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                for (let i = 0; i < files.length; i++) {
                    await handleFile(files[i]);
                }
            }
        });

        fileInput.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files || []);
            if (files.length === 0) return;
            // Auto-detect multi vs single
            if (files.length === 1) {
                await handleFile(files[0]);
            } else {
                // Show multi-file controls and populate list
                const controls = document.getElementById('multiFilesControls');
                if (controls) controls.style.display = 'block';
                if (!window.__multiFiles) window.__multiFiles = new Map();
                const material = document.getElementById('materialTypeSelect').value;
                const thickness = document.getElementById('thicknessSelect').value;
                const grade = document.getElementById('gradeSelect').value;
                const finish = document.getElementById('finishSelect').value;
                files.forEach(f => {
                    if (!f.name.toLowerCase().endsWith('.dxf')) return;
                    const id = 'f_' + Date.now() + '_' + Math.random().toString(36).slice(2);
                    window.__multiFiles.set(id, { file: f, material_name: material, thickness, grade, finish });
                });
                // Render list
                const list = document.getElementById('multiFilesList');
                const processBtn = document.getElementById('processMultiBtn');
                if (list && processBtn) {
                    list.innerHTML = '';
                    window.__multiFiles.forEach((cfg, id) => {
                        const row = document.createElement('div');
                        row.className = 'mf-item';
                        const info = document.createElement('div'); info.className = 'mf-info';
                        info.textContent = `${cfg.file.name} — ${cfg.material_name || '-'} / ${cfg.thickness || '-'} / ${cfg.grade || '-'} / ${cfg.finish || '-'}`;
                        const actions = document.createElement('div'); actions.className = 'mf-actions';
                        const editBtn = document.createElement('button'); editBtn.className = 'btn'; editBtn.textContent = 'Edit'; editBtn.addEventListener('click', () => openFileMaterialModal(id));
                        const removeBtn = document.createElement('button'); removeBtn.className = 'btn mf-remove'; removeBtn.textContent = 'Remove'; removeBtn.addEventListener('click', () => { window.__multiFiles.delete(id); fileInput.value=''; fileInfo.style.display='none'; renderAfterRemove(); });
                        actions.appendChild(editBtn); actions.appendChild(removeBtn);
                        row.appendChild(info); row.appendChild(actions);
                        list.appendChild(row);
                    });
                    processBtn.style.display = 'inline-block';
                    processBtn.onclick = processMultiQuotation;
                }
            }
        });

        function renderAfterRemove() {
            const list = document.getElementById('multiFilesList');
            const processBtn = document.getElementById('processMultiBtn');
            if (!window.__multiFiles || window.__multiFiles.size === 0) {
                if (list) list.innerHTML = '';
                if (processBtn) processBtn.style.display = 'none';
                const controls = document.getElementById('multiFilesControls');
                if (controls) controls.style.display = 'none';
                return;
            }
            // Re-render list
            if (list) {
                list.innerHTML = '';
                window.__multiFiles.forEach((cfg, id) => {
                    const row = document.createElement('div'); row.className = 'mf-item';
                    const info = document.createElement('div'); info.className = 'mf-info'; info.textContent = `${cfg.file.name} — ${cfg.material_name || '-'} / ${cfg.thickness || '-'} / ${cfg.grade || '-'} / ${cfg.finish || '-'}`;
                    const actions = document.createElement('div'); actions.className = 'mf-actions'; const editBtn = document.createElement('button'); editBtn.className = 'btn'; editBtn.type = 'button'; editBtn.textContent = 'Edit'; editBtn.addEventListener('click', (ev) => { ev.preventDefault(); openFileMaterialModal(id); }); const removeBtn = document.createElement('button'); removeBtn.className = 'btn mf-remove'; removeBtn.type = 'button'; removeBtn.textContent = 'Remove'; removeBtn.addEventListener('click', (ev) => { ev.preventDefault(); window.__multiFiles.delete(id); renderAfterRemove(); }); actions.appendChild(editBtn); actions.appendChild(removeBtn);
                    row.appendChild(info); row.appendChild(actions); list.appendChild(row);
                });
                if (processBtn) processBtn.style.display = 'inline-block';
            }
        }

        // Load materials data on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Debug log suppressed
            loadMaterialsData();
            initializeExternalServices();
            setupMaterialUpdates();
            
            // Add event listeners for cascading dropdowns
            const materialTypeSelect = document.getElementById('materialTypeSelect');
            const thicknessSelect = document.getElementById('thicknessSelect');
            const gradeSelect = document.getElementById('gradeSelect');
            
            if (materialTypeSelect) {
                materialTypeSelect.addEventListener('change', function() {
                    updateFilteredOptions('materialTypeSelect');
                });
            }
            
            if (thicknessSelect) {
                thicknessSelect.addEventListener('change', function() {
                    updateFilteredOptions('thicknessSelect');
                });
            }
            
            if (gradeSelect) {
                gradeSelect.addEventListener('change', function() {
                    updateFilteredOptions('gradeSelect');
                });
            }
            // Initialize multi-file UI handlers
            const addBtn = document.getElementById('addMultiFilesBtn');
            const input = document.getElementById('multiFilesInput');
            const list = document.getElementById('multiFilesList');
            const processBtn = document.getElementById('processMultiBtn');
            window.__multiFiles = new Map();
            if (addBtn && input) {
                addBtn.addEventListener('click', () => input.click());
                input.addEventListener('change', (e) => {
                    const files = Array.from(e.target.files || []);
                    const material = document.getElementById('materialTypeSelect').value;
                    const thickness = document.getElementById('thicknessSelect').value;
                    const grade = document.getElementById('gradeSelect').value;
                    const finish = document.getElementById('finishSelect').value;
                    files.forEach(f => {
                        if (!f.name.toLowerCase().endsWith('.dxf')) return;
                        const id = 'f_' + Date.now() + '_' + Math.random().toString(36).slice(2);
                        window.__multiFiles.set(id, { file: f, material_name: material, thickness, grade, finish });
                    });
                    renderMultiFilesList();
                    e.target.value = '';
                });
            }
            function renderMultiFilesList() {
                if (!list || !processBtn) return;
                list.innerHTML = '';
                if (window.__multiFiles.size === 0) { processBtn.style.display = 'none'; return; }
                window.__multiFiles.forEach((cfg, id) => {
                    const row = document.createElement('div');
                    row.style.display = 'flex';
                    row.style.justifyContent = 'space-between';
                    row.style.alignItems = 'center';
                    row.style.gap = '8px';
                    row.style.padding = '8px 10px';
                    row.style.border = '1px solid #e9ecef';
                    row.style.borderRadius = '8px';
                    row.style.marginBottom = '8px';
                    const info = document.createElement('div');
                    info.textContent = `${cfg.file.name} — ${cfg.material_name || '-'} / ${cfg.thickness || '-'} / ${cfg.grade || '-'} / ${cfg.finish || '-'}`;
                    const actions = document.createElement('div');
                    const editBtn = document.createElement('button'); editBtn.className = 'btn'; editBtn.type = 'button'; editBtn.textContent = 'Edit'; editBtn.addEventListener('click', (ev) => { ev.preventDefault(); openFileMaterialModal(id); });
                    const removeBtn = document.createElement('button'); removeBtn.className = 'btn mf-remove'; removeBtn.type = 'button'; removeBtn.textContent = 'Remove'; removeBtn.addEventListener('click', (ev) => { ev.preventDefault(); window.__multiFiles.delete(id); renderMultiFilesList(); });
                    actions.appendChild(editBtn); actions.appendChild(removeBtn);
                    row.appendChild(info); row.appendChild(actions);
                    list.appendChild(row);
                });
                processBtn.style.display = 'inline-block';
                processBtn.onclick = processMultiQuotation;
            }
            
            // Add a test function to verify external services are working
            // window.testExternalServices removed in production
        });
        // Per-file edit modal logic (uses dedicated modal)
        let __editingFileId = null;
        function openFileMaterialModal(id) {
            __editingFileId = id;
            const modal = document.getElementById('fileMaterialModal');
            if (!modal) return;
            const cfg = window.__multiFiles.get(id);
            const fmMat = document.getElementById('fmMaterialTypeSelect');
            // Copy main materials
            const mainMat = document.getElementById('materialTypeSelect');
            fmMat.innerHTML = mainMat.innerHTML;
            fmMat.value = cfg.material_name || '';
            const loadChain = async () => {
                const params = new URLSearchParams({ material_name: fmMat.value });
                const res = await fetch(`/api/materials/filtered?${params}`);
                const data = await res.json();
                const fmTh = document.getElementById('fmThicknessSelect');
                fmTh.innerHTML = '<option value="">Select Thickness</option>' + (data.thicknesses || []).map(t => `<option value="${t}">${t} mm</option>`).join('');
                fmTh.value = cfg.thickness || '';
                const fmGr = document.getElementById('fmGradeSelect');
                fmGr.innerHTML = '<option value="">Select Grade</option>' + (data.grades || []).map(g => `<option value="${g}">${g || 'Empty'}</option>`).join('');
                fmGr.value = cfg.grade || '';
                const fmFi = document.getElementById('fmFinishSelect');
                fmFi.innerHTML = '<option value="">Select Finish</option>' + (data.finishes || []).map(f => `<option value="${f}">${f}</option>`).join('');
                fmFi.value = cfg.finish || '';

                // Wire cascading updates within the modal
                fmTh.onchange = async () => {
                    const p = new URLSearchParams({ material_name: fmMat.value, thickness: fmTh.value });
                    const r = await fetch(`/api/materials/filtered?${p}`);
                    const d = await r.json();
                    const fmGrEl = document.getElementById('fmGradeSelect');
                    fmGrEl.innerHTML = '<option value="">Select Grade</option>' + (d.grades || []).map(g => `<option value="${g}">${g || 'Empty'}</option>`).join('');
                    const fmFiEl = document.getElementById('fmFinishSelect');
                    fmFiEl.innerHTML = '<option value="">Select Finish</option>' + (d.finishes || []).map(f => `<option value="${f}">${f}</option>`).join('');
                };
                fmGr.onchange = async () => {
                    const p = new URLSearchParams({ material_name: fmMat.value });
                    if (fmTh.value) p.append('thickness', fmTh.value);
                    if (fmGr.value) p.append('grade', fmGr.value);
                    const r = await fetch(`/api/materials/filtered?${p}`);
                    const d = await r.json();
                    const fmFiEl = document.getElementById('fmFinishSelect');
                    fmFiEl.innerHTML = '<option value="">Select Finish</option>' + (d.finishes || []).map(f => `<option value="${f}">${f}</option>`).join('');
                };
            };
            fmMat.onchange = loadChain;
            loadChain();
            modal.style.display = 'block';
        }
        function closeFileMaterialModal() {
            const modal = document.getElementById('fileMaterialModal');
            if (modal) modal.style.display = 'none';
            __editingFileId = null;
        }
        function saveFileMaterialModal() {
            if (!__editingFileId) return closeFileMaterialModal();
            const cfg = window.__multiFiles.get(__editingFileId);
            if (!cfg) return closeFileMaterialModal();
            cfg.material_name = document.getElementById('fmMaterialTypeSelect').value || '';
            cfg.thickness = document.getElementById('fmThicknessSelect').value || '';
            cfg.grade = document.getElementById('fmGradeSelect').value || '';
            cfg.finish = document.getElementById('fmFinishSelect').value || '';
            window.__multiFiles.set(__editingFileId, cfg);
            const refresh = document.getElementById('multiFilesInput');
            // Re-render list
            const list = document.getElementById('multiFilesList');
            if (list) { list.innerHTML = ''; }
            // Quick re-render
            const evt = new Event('noop'); // placeholder
            // Re-create list quickly
            const lst = document.getElementById('multiFilesList');
            if (lst) {
                lst.innerHTML = '';
                window.__multiFiles.forEach((cfg, id) => {
                    const row = document.createElement('div');
                    row.className = 'mf-item';
                    const info = document.createElement('div'); 
                    info.className = 'mf-info';
                    info.textContent = `${cfg.file.name} — ${cfg.material_name || '-'} / ${cfg.thickness || '-'} / ${cfg.grade || '-'} / ${cfg.finish || '-'}`;
                    const actions = document.createElement('div'); 
                    actions.className = 'mf-actions';
                    const editBtn = document.createElement('button'); 
                    editBtn.className = 'btn'; 
                    editBtn.type = 'button'; 
                    editBtn.textContent = 'Edit'; 
                    editBtn.addEventListener('click', (ev) => { ev.preventDefault(); openFileMaterialModal(id); });
                    const removeBtn = document.createElement('button'); 
                    removeBtn.className = 'btn mf-remove'; 
                    removeBtn.type = 'button'; 
                    removeBtn.textContent = 'Remove'; 
                    removeBtn.addEventListener('click', (ev) => { ev.preventDefault(); window.__multiFiles.delete(id); saveFileMaterialModal(); });
                    actions.appendChild(editBtn); 
                    actions.appendChild(removeBtn);
                    row.appendChild(info); 
                    row.appendChild(actions); 
                    lst.appendChild(row);
                });
                const processBtn = document.getElementById('processMultiBtn'); 
                if (processBtn) processBtn.style.display = window.__multiFiles.size ? 'inline-block' : 'none';
            }
            closeFileMaterialModal();
        }

        async function processMultiQuotation() {
            if (!window.__multiFiles || window.__multiFiles.size === 0) { showError('Please add DXF files first.'); return; }
            processing.style.display = 'block'; hideMessages();
            let jobId = null; try { const r = await fetch('/api/progress/start', { method: 'POST' }); const j = await r.json(); jobId = j.job_id; } catch {}
            const pc = document.getElementById('progressContainer'); const pb = document.getElementById('progressBar'); const pl = document.getElementById('progressLabel'); let pollTimer = null;
            if (jobId && pc && pb && pl) { pc.style.display = 'block'; pb.style.width = '0%'; pl.textContent = '0%'; const poll = async () => { try { const res = await fetch(`/api/progress/${jobId}`); if (res.ok) { const info = await res.json(); const pct = Math.max(0, Math.min(100, parseInt(info.percent || 0))); pb.style.width = pct + '%'; pl.textContent = `${pct}%${info.message ? ' - ' + info.message : ''}`; if (info.status === 'done' || info.status === 'error') { clearInterval(pollTimer); } } } catch {} }; pollTimer = setInterval(poll, 500); poll(); }
            try {
                const fd = new FormData(); fd.append('scrap_factor', document.getElementById('scrapFactor').value || '1.20');
                const arr = Array.from(window.__multiFiles.values()); arr.forEach(cfg => fd.append('files', cfg.file));
                const settings = arr.map(cfg => ({ name: cfg.file.name, material_name: cfg.material_name, thickness: cfg.thickness, grade: cfg.grade, finish: cfg.finish })); fd.append('file_settings', JSON.stringify(settings)); if (jobId) fd.append('job_id', jobId);
                const resp = await fetch('/upload-multi', { method: 'POST', body: fd }); const data = await resp.json(); processing.style.display = 'none'; if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
                if (jobId && pc) { pb.style.width = '100%'; pl.textContent = '100% - Completed'; setTimeout(() => { pc.style.display = 'none'; }, 1200); }
                if (data.success) { showResults(data); } else { showError(data.error || 'Failed to process files.'); }
            } catch (e) { processing.style.display = 'none'; if (pollTimer) { clearInterval(pollTimer); pollTimer = null; } if (jobId && pc) pc.style.display = 'none'; showError('Network error: ' + e.message); }
        }

        // Real-time material updates setup
        function setupMaterialUpdates() {
            const eventSource = new EventSource('/api/materials/events');
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.type === 'material_added' || data.type === 'material_updated' || data.type === 'material_deleted') {
                    // Debug log suppressed
                    // Reload materials data to update dropdowns
                    loadMaterialsData();
                    
                    // Also refresh current filtered options if user has selections
                    const materialType = document.getElementById('materialTypeSelect').value;
                    if (materialType) {
                        updateFilteredOptions();
                    }
                }
            };
            
            eventSource.onerror = function(event) {
                console.error('SSE connection error:', event);
                // Attempt to reconnect after 5 seconds
                setTimeout(() => {
                    setupMaterialUpdates();
                }, 5000);
            };
        }

        // Dynamic dropdown functionality
        function loadMaterialsData() {
            fetch('/api/materials/data')
                .then(response => response.json())
                .then(data => {
                    populateMaterialTypeDropdown(data.material_names);
                })
                .catch(error => {
                    console.error('Error loading materials data:', error);
                });
        }

        // Nesting functionality removed for deployment

        function populateMaterialTypeDropdown(materialNames) {
            const materialTypeSelect = document.getElementById('materialTypeSelect');
            materialTypeSelect.innerHTML = '<option value="">Select Material Name</option>';
            
            materialNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                materialTypeSelect.appendChild(option);
            });
        }

        let lastChangedDropdown = '';

        function updateFilteredOptions(changedDropdown = '') {
            const materialType = document.getElementById('materialTypeSelect').value;
            const thickness = document.getElementById('thicknessSelect').value;
            const grade = document.getElementById('gradeSelect').value;
            
            if (!materialType) {
                resetDependentDropdowns();
                return;
            }

            // Track which dropdown was changed
            if (changedDropdown) {
                lastChangedDropdown = changedDropdown;
            }

            const params = new URLSearchParams({
                material_name: materialType
            });
            
            if (thickness) params.append('thickness', thickness);
            if (grade) params.append('grade', grade);

            fetch(`/api/materials/filtered?${params}`)
                .then(response => response.json())
                .then(data => {
                    
                    // Material Type changed - update thickness and reset others
                    if (lastChangedDropdown === 'materialTypeSelect') {
                        // Debug log suppressed
                        populateThicknessDropdown(data.thicknesses);
                        document.getElementById('gradeSelect').innerHTML = '<option value="">Select Thickness First</option>';
                        document.getElementById('finishSelect').innerHTML = '<option value="">Select Grade First</option>';
                    }
                    // Thickness changed - update grade and reset finish
                    else if (lastChangedDropdown === 'thicknessSelect') {
                        // Debug log suppressed
                        populateGradeDropdown(data.grades);
                        document.getElementById('finishSelect').innerHTML = '<option value="">Select Grade First</option>';
                    }
                    // Grade changed - update finish
                    else if (lastChangedDropdown === 'gradeSelect') {
                        // Debug log suppressed
                        populateFinishDropdown(data.finishes);
                    }
                    // Initial load or other case - populate all available options
                    else {
                        // Debug log suppressed
                        populateThicknessDropdown(data.thicknesses);
                        populateGradeDropdown(data.grades);
                        populateFinishDropdown(data.finishes);
                    }
                })
                .catch(error => {
                    console.error('Error loading filtered options:', error);
                });
        }

        function populateThicknessDropdown(thicknesses) {
            const thicknessSelect = document.getElementById('thicknessSelect');
            if (!thicknessSelect) {
                return;
            }
            thicknessSelect.innerHTML = '<option value="">Select Thickness</option>';
            
            thicknesses.forEach(thickness => {
                const option = document.createElement('option');
                option.value = thickness;
                option.textContent = `${thickness} mm`;
                thicknessSelect.appendChild(option);
            });
        }

        function populateGradeDropdown(grades) {
            const gradeSelect = document.getElementById('gradeSelect');
            if (!gradeSelect) {
                return;
            }
            gradeSelect.innerHTML = '<option value="">Select Grade</option>';
            
            grades.forEach(grade => {
                const option = document.createElement('option');
                option.value = grade;
                option.textContent = grade === '' ? 'Empty' : grade;
                gradeSelect.appendChild(option);
            });
        }

        function populateFinishDropdown(finishes) {
            const finishSelect = document.getElementById('finishSelect');
            if (!finishSelect) {
                return;
            }
            finishSelect.innerHTML = '<option value="">Select Finish</option>';
            
            finishes.forEach(finish => {
                const option = document.createElement('option');
                option.value = finish;
                option.textContent = finish;
                finishSelect.appendChild(option);
            });
        }

        function resetDependentDropdowns() {
            document.getElementById('thicknessSelect').innerHTML = '<option value="">Select Material Type First</option>';
            document.getElementById('gradeSelect').innerHTML = '<option value="">Select Material Type First</option>';
            document.getElementById('finishSelect').innerHTML = '<option value="">Select Material Type First</option>';
        }

        // Add event listeners for cascading dropdowns - moved to DOMContentLoaded

        async function handleFile(file) {
            // Validate file type
            if (!file.name.toLowerCase().endsWith('.dxf')) {
                showError('Please select a valid DXF file.');
                return;
            }

            // Material selections may be empty; we will auto-fill from extracted labels
            const materialType = document.getElementById('materialTypeSelect').value;
            const thickness = document.getElementById('thicknessSelect').value;
            const grade = document.getElementById('gradeSelect').value;
            const finish = document.getElementById('finishSelect').value;

            // Show file info
            fileInfo.style.display = 'block';
            fileInfo.innerHTML = `
                <strong>Selected File:</strong> ${file.name}<br>
                <strong>Size:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB
            `;

            // Show processing
            processing.style.display = 'block';
            resultsSection.style.display = 'none';
            hideMessages();

            // Request a job id for progress tracking
            let jobId = null;
            try {
                const r = await fetch('/api/progress/start', { method: 'POST' });
                const j = await r.json();
                jobId = j.job_id;
            } catch {}

            // Show progress UI if we have a job id
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressLabel = document.getElementById('progressLabel');
            let pollTimer = null;
            if (jobId && progressContainer && progressBar && progressLabel) {
                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
                progressLabel.textContent = '0%';
                // Poll backend for progress
                const poll = async () => {
                    try {
                        const res = await fetch(`/api/progress/${jobId}`);
                        if (res.ok) {
                            const info = await res.json();
                            const pct = Math.max(0, Math.min(100, parseInt(info.percent || 0)));
                            progressBar.style.width = pct + '%';
                            progressLabel.textContent = `${pct}%${info.message ? ' - ' + info.message : ''}`;
                            if (info.status === 'done' || info.status === 'error') {
                                clearInterval(pollTimer);
                            }
                        }
                    } catch {}
                };
                pollTimer = setInterval(poll, 1000); // Reduced frequency from 500ms to 1000ms
                poll();
            }

            // Create FormData for analyze-only (no pricing yet)
            const formData = new FormData();
            formData.append('file', file);
            // May be empty; backend will infer from extracted labels if missing
            formData.append('material_name', materialType || '');
            formData.append('thickness', thickness || '');
            formData.append('grade', grade || '');
            formData.append('finish', finish || '');
            
            // Add SCRAP factor
            const scrapFactor = document.getElementById('scrapFactor').value;
            formData.append('scrap_factor', scrapFactor);
            formData.append('analyze_only', '1');
            window.__lastFile = file; // keep the File object for final pricing

            if (jobId) formData.append('job_id', jobId);
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                processing.style.display = 'none';
                if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
                if (jobId) {
                    // ensure 100% on completion
                    progressBar.style.width = '100%';
                    progressLabel.textContent = '100% - Completed';
                    setTimeout(() => { if (progressContainer) progressContainer.style.display = 'none'; }, 1200);
                }
                
                if (data.success) {
                    // Check if any parts are missing material information
                    const missingMaterials = checkMissingMaterials(data);
                    
                    if (missingMaterials.length > 0) {
                        // Show material selection popup
                        showMaterialPopup(missingMaterials, data);
                    } else {
                        // All materials are present, proceed normally
                        try { autoFillFromExtractedLabels(data); } catch(e) { console.warn('Auto-fill labels failed', e); }
                        // Remember last upload params for final quote
                        window.__lastUploadParams = { single: true, fileName: file.name, materialType: document.getElementById('materialTypeSelect').value, thickness: document.getElementById('thicknessSelect').value, grade: document.getElementById('gradeSelect').value, finish: document.getElementById('finishSelect').value };
                        // Do NOT compute price here; just show parts/metrics
                        showResults(data);
                        // Parts analyzed successfully
                        successMessage.textContent = 'Parts analyzed successfully. You can now calculate the quote.';
                        successMessage.style.display = 'block';
                        setTimeout(() => { successMessage.style.display = 'none'; }, 3000);
                    }
                } else {
                    showError(data.error || 'An error occurred while processing the file.');
                }
            })
            .catch(error => {
                processing.style.display = 'none';
                if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
                if (jobId && progressContainer) progressContainer.style.display = 'none';
                showError('Network error: ' + error.message);
            });
        }

        // Reusable builder for the Cost Breakdown card
        function buildCostBreakdownHTML(cd, objectPartsCount) {
            try {
                // Derive numeric dimensions first (length/width from cd or area fallback)
                const lengthNum = (cd && (cd.area_sq_mm != null || cd.length_mm != null)) ? calculatePartLength(cd.area_sq_mm, cd.length_mm) : null;
                const widthNum  = (cd && (cd.area_sq_mm != null || cd.width_mm  != null)) ? calculatePartWidth(cd.area_sq_mm, cd.width_mm)   : null;
                // Fallback perimeter from L and W if missing
                let perimeterNum = (cd && cd.perimeter_meters != null) ? Number(cd.perimeter_meters) : null;
                if ((perimeterNum == null || !isFinite(perimeterNum)) && typeof lengthNum === 'number' && typeof widthNum === 'number') {
                    perimeterNum = (2 * (lengthNum + widthNum)) / 1000.0; // mm -> m
                }

                const perimeter = (typeof perimeterNum === 'number' && isFinite(perimeterNum)) ? perimeterNum.toFixed(3) : '0.000';
                const length = (typeof lengthNum === 'number' && isFinite(lengthNum)) ? lengthNum.toFixed(1) : '0.0';
                const width  = (typeof widthNum  === 'number' && isFinite(widthNum))  ? widthNum.toFixed(1)  : '0.0';
                const laser  = (cd && cd.laser_cost    != null) ? Number(cd.laser_cost).toFixed(2) : '0.00';
                const mat    = (cd && cd.material_cost != null) ? Number(cd.material_cost).toFixed(2) : '0.00';
                const bendLn = (cd && cd.total_bending_lines != null) ? cd.total_bending_lines : (cd && cd.bending_count != null) ? cd.bending_count : 0;
                const bend   = (cd && cd.bending_cost  != null) ? Number(cd.bending_cost).toFixed(2) : '0.00';
                const vgLen  = (cd && cd.vgroove_length_meters != null) ? Number(cd.vgroove_length_meters).toFixed(3) : '0.000';
                const vgCost = (cd && cd.vgroove_cost          != null) ? Number(cd.vgroove_cost).toFixed(2) : '0.00';
                const total  = (cd && cd.total_cost            != null) ? Number(cd.total_cost).toFixed(2) : '0.00';
                const parts  = (objectPartsCount != null) ? objectPartsCount : 1;

                return `
                    <h4>💰 Cost Breakdown</h4>
                    <div class="cost-details">
                        <div class="cost-detail">
                            <span class="cost-label">Object Parts:</span>
                            <span class="cost-value">${parts}</span>
                        </div>
                        <div class="cost-detail">
                            <span class="cost-label">Perimeter:</span>
                            <span class="cost-value">${perimeter} m</span>
                        </div>
                        <div class="cost-detail">
                            <span class="cost-label">Length:</span>
                            <span class="cost-value">${length} mm</span>
                        </div>
                        <div class="cost-detail">
                            <span class="cost-label">Width:</span>
                            <span class="cost-value">${width} mm</span>
                        </div>
                        <div class="cost-detail">
                            <span class="cost-label">Laser Cost:</span>
                            <span class="cost-value">$${laser}</span>
                        </div>
                        <div class="cost-detail">
                            <span class="cost-label">Material Cost:</span>
                            <span class="cost-value">$${mat}</span>
                        </div>
                        <div class="cost-detail">
                            <span class="cost-label">Bending Lines:</span>
                            <span class="cost-value">${bendLn}</span>
                        </div>
                        <div class="cost-detail">
                            <span class="cost-label">Bending Cost:</span>
                            <span class="cost-value">$${bend}</span>
                        </div>
                        <div class="cost-detail">
                            <span class="cost-label">V-Groove Length:</span>
                            <span class="cost-value">${vgLen} m</span>
                        </div>
                        <div class="cost-detail">
                            <span class="cost-label">V-Groove Cost:</span>
                            <span class="cost-value">$${vgCost}</span>
                        </div>
                        <div class="cost-detail">
                            <span class="cost-label">Total Cost:</span>
                            <span class="cost-value">$${total}</span>
                        </div>
                    </div>
                `;
            } catch (e) {
                console.error('Error building cost breakdown HTML', e);
                return '';
            }
        }

        function renderCostBreakdownForPart(partNumber, partCost) {
            try {
                const partCard = document.querySelector(`[data-part="${partNumber}"]`);
                if (!partCard) return;
                // Remove any existing card to avoid duplicates
                const existing = partCard.querySelector('.part-cost-info');
                if (existing) existing.remove();

                let cd = (partCost && partCost.cost_data) ? partCost.cost_data : {};
                let objectPartsCount = (partCost && partCost.object_parts_count != null) ? partCost.object_parts_count : (cd && cd.object_parts_count);

                // Fallback: if cd is missing core dimensions, derive them from part_images
                try {
                    const allParts = (window.currentData && Array.isArray(window.currentData.part_images)) ? window.currentData.part_images : [];
                    const partImg = allParts.find(p => parseInt(p.part_number) === parseInt(partNumber));
                    if (partImg) {
                        const derived = { ...cd };
                        if (derived.area_sq_mm == null && typeof partImg.area === 'number') {
                            derived.area_sq_mm = partImg.area * 1e6;
                        }
                        if (derived.length_mm == null && typeof partImg.length_mm === 'number') {
                            derived.length_mm = partImg.length_mm;
                        }
                        if (derived.width_mm == null && typeof partImg.width_mm === 'number') {
                            derived.width_mm = partImg.width_mm;
                        }
                        // Ensure numeric defaults for counts/costs to avoid empty labels
                        if (derived.vgroove_count == null) derived.vgroove_count = 0;
                        if (derived.bending_count == null) derived.bending_count = 0;
                        if (derived.total_bending_lines == null) derived.total_bending_lines = 0;
                        if (derived.laser_cost == null) derived.laser_cost = 0;
                        if (derived.material_cost == null) derived.material_cost = 0;
                        if (derived.bending_cost == null) derived.bending_cost = 0;
                        if (derived.vgroove_length_meters == null) derived.vgroove_length_meters = 0;
                        if (derived.vgroove_cost == null) derived.vgroove_cost = 0;
                        if (derived.total_cost == null) derived.total_cost = 0;
                        cd = derived;
                    }
                } catch (e) {
                    // silent fallback
                }

                if (objectPartsCount == null) objectPartsCount = 1;

                const costInfo = document.createElement('div');
                costInfo.className = 'part-cost-info';

                // Always show the cost breakdown card. If there's an error, display the warning above it.
                if (partCost && partCost.calculation_error) {
                    const errorHtml = `
                        <h4>❌ Calculation Error</h4>
                        <div class="calculation-error">
                            <div class="error-message">
                                <strong>Error:</strong> ${partCost.calculation_error}
                            </div>
                            <div class="error-details">
                                <p>This part is missing material assignment (type/grade/finish or thickness). The breakdown below shows zeros until materials are set.</p>
                            </div>
                        </div>
                    `;
                    costInfo.classList.add('has-error');
                    costInfo.innerHTML = errorHtml + buildCostBreakdownHTML(cd, objectPartsCount);
                } else {
                    costInfo.innerHTML = buildCostBreakdownHTML(cd, objectPartsCount);
                }

                partCard.appendChild(costInfo);
            } catch (e) {
                console.error('Error rendering cost breakdown for part', partNumber, e);
            }
        }

        function showResults(data) {
            // Clean previously injected dynamic sections to avoid duplicates
            try {
                const resultsSection = document.getElementById('resultsSection');
                if (resultsSection) {
                    resultsSection.querySelectorAll('.parts-section, .cost-section, .pdf-section').forEach(el => el.remove());
                }
            } catch {}

            // Dedupe part arrays by part_number to prevent duplicates on re-render
            try {
                const dedupeByPartNumber = (arr) => {
                    if (!Array.isArray(arr)) return [];
                    const seen = new Set();
                    const out = [];
                    for (const it of arr) {
                        const pn = (it && typeof it.part_number !== 'undefined') ? it.part_number : null;
                        if (pn == null) continue;
                        if (seen.has(pn)) continue;
                        seen.add(pn);
                        out.push(it);
                    }
                    return out;
                };
                if (Array.isArray(data.part_images)) data.part_images = dedupeByPartNumber(data.part_images);
                if (Array.isArray(data.part_costs)) data.part_costs = dedupeByPartNumber(data.part_costs);
            } catch {}

            // Lock scrap factor to the last computed value if present (prevents drift)
            try {
                if (data && typeof data.scrap_factor === 'number') {
                    const sfEl = document.getElementById('scrapFactor');
                    if (sfEl) {
                        sfEl.value = Number(data.scrap_factor).toFixed(3);
                    }
                }
            } catch {}

            // Display statistics (avoid showing nulls)
            const oe = (data.stats && data.stats.original_entities != null) ? data.stats.original_entities : 0;
            const fe = (data.stats && data.stats.filtered_entities != null) ? data.stats.filtered_entities : 0;
            const re = (data.stats && data.stats.removed_entities != null) ? data.stats.removed_entities : 0;
            const tp = (data.stats && data.stats.total_parts != null) ? data.stats.total_parts : 0;
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${oe}</div>
                    <div class="stat-label">Original Entities</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${fe}</div>
                    <div class="stat-label">Filtered Entities</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${re}</div>
                    <div class="stat-label">Removed Entities</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${tp}</div>
                    <div class="stat-label">Parts Found</div>
                </div>
            `;

            // Display main image(s)
            if (Array.isArray(data.images) && data.images.length > 0) {
                // Show all images stacked
                const container = dxfImage.parentElement;
                container.innerHTML = '';
                data.images.forEach(img => {
                    const im = document.createElement('img');
                    im.className = 'dxf-image';
                    im.alt = img.file || 'DXF Overview';
                    im.src = 'data:image/png;base64,' + img.image;
                    im.style.marginBottom = '10px';
                    container.appendChild(im);
                });
            } else {
                dxfImage.src = 'data:image/png;base64,' + data.image;
            }
            
            // Store data globally for cost calculations
            window.currentData = data;
            try { renderMaterialsSection(data); } catch(e) { console.warn('renderMaterialsSection failed', e); }
            try { autoFillFromExtractedLabels(data); } catch(e) { console.warn('Auto-fill material from labels (showResults) failed', e); }
            
                        // Display individual parts if available
            if (data.part_images && data.part_images.length > 0) {
                const partsSection = document.createElement('div');
                partsSection.className = 'parts-section';
                partsSection.innerHTML = `
                    <div class="parts-header">
                        <h3>Individual Parts Detected (${data.stats.total_parts} total)</h3>
                        <p>Each part is shown separately with its own visualization</p>
                    </div>
                    <div class="parts-grid" id="partsGrid"></div>
                `;
                
                resultsSection.appendChild(partsSection);
                
                const partsGrid = document.getElementById('partsGrid');
                data.part_images.forEach((part, index) => {
                    const costData = (data.part_costs || []).find(pc => pc.part_number === part.part_number);
                    const baseCost = (costData && costData.cost_data && typeof costData.cost_data.total_cost === 'number') ? costData.cost_data.total_cost : 0;
                    const L = (typeof part.length_mm === 'number') ? part.length_mm : (costData && typeof costData.length_mm === 'number' ? costData.length_mm : null);
                    const W = (typeof part.width_mm === 'number') ? part.width_mm : (costData && typeof costData.width_mm === 'number' ? costData.width_mm : null);
                    const areaSqMm = (typeof part.area === 'number') ? (part.area * 1e6) : (costData && costData.cost_data && typeof costData.cost_data.area_sq_mm === 'number' ? costData.cost_data.area_sq_mm : (L && W ? L * W : null));

                    const partCard = document.createElement('div');
                    partCard.className = 'part-card';
                    partCard.setAttribute('data-part', part.part_number);
                    
                    // Use updated part_labels if available, otherwise fall back to extracted_label
                    const partLabel = data.part_labels && data.part_labels[part.part_number] ? data.part_labels[part.part_number] : {};
                    const extractedLabel = part.extracted_label || {};
                    const label = { ...extractedLabel, ...partLabel }; // partLabel overrides extractedLabel
                    
                    const typeText = extractedLabel.type_text || '';
                    const qtyFromLabel = (typeof label.quantity === 'number' && label.quantity >= 0) ? label.quantity : '';
                    const matText = (label.material_name || '');
                    const thText = (label.thickness != null ? `${label.thickness} mm` : '');
                    const gfText = [label.grade != null ? String(label.grade) : '', label.finish || ''].filter(Boolean).join(' / ');
                    partCard.innerHTML = `
                        <div class="part-header">
                            <h4>Part ${part.part_number}</h4>
                        </div>
                        <div class="part-image">
                            <img src="data:image/png;base64,${part.image}" alt="Part ${part.part_number}">
                        </div>
                        <div class="part-stats">
                            <div class="stat-number">${part.entity_count}</div>
                            <div class="stat-label">Entities</div>
                            <div class="area-info">
                                <div class="area-number">${part.area.toFixed(2)}</div>
                                <div class="area-label">Area (million sq units)</div>
                            </div>
                            <div class="area-info" style="margin-top:6px;">
                                <div class="area-number">${(L ?? 0).toFixed(1)} × ${(W ?? 0).toFixed(1)} mm</div>
                                <div class="area-label">L × W</div>
                            </div>

                            ${typeText ? `
                            <div class="area-info" style="margin-top:6px;">
                                <div class="area-number" style="font-size:0.95em;">${typeText}</div>
                                <div class="area-label">Extracted</div>
                            </div>` : ''}
                            ${(matText || thText || gfText) ? `
                            <div class="area-info" style="margin-top:4px;">
                                <div class="area-number" style="font-size:0.9em;">${[matText, thText, gfText].filter(Boolean).join(' · ')}</div>
                                <div class="area-label">Parsed</div>
                            </div>` : ''}
                            ${costData && costData.cost_data && costData.cost_data.total_bending_lines > 0 ? `
                            <div class="bending-info">
                                <div class="bending-number">${costData.cost_data.total_bending_lines}</div>
                                <div class="bending-label">Total Bending Lines</div>
                            </div>
                            ` : ''}
                        </div>
                        <div class="piece-counter">
                            <button class="counter-btn" data-part="${part.part_number}" data-action="decrease" title="Click: -1, Hold: continuous -10">-</button>
                            <input class="piece-input" type="number" min="1" step="1" value="${qtyFromLabel || 1}" placeholder="${qtyFromLabel || 1}" data-part-qty="${part.part_number}" />
                            <button class="counter-btn" data-part="${part.part_number}" data-action="increase" title="Click: +1, Hold: continuous +10">+</button>
                        </div>
                        <div class="part-cost">
                            <div class="unit-cost">Unit: $${baseCost.toFixed(2)}</div>
                            <div class="total-cost">Total: $${(baseCost * (qtyFromLabel || 1)).toFixed(2)}</div>
                        </div>
                        <div class="action-buttons">
                            <button class="action-btn delete-btn" onclick="deletePart(${part.part_number})">Delete</button>
                            <button class="action-btn revoke-btn" onclick="revokePart(${part.part_number})" style="display: none;">Revoke</button>
                        </div>
                    `;
                    partsGrid.appendChild(partCard);
                });
                
                // Add long-press functionality for counter buttons
                setupLongPressCounters();
                


                // Add cost section if cost data is available
                if (data.stats.total_cost !== undefined) {
                    const costSection = document.createElement('div');
                    costSection.className = 'cost-section';
                    costSection.innerHTML = `
                        <h3>💰 Total Project Cost</h3>
                        <div class="cost-breakdown">
                            <div class="cost-breakdown-item">
                                <span class="cost-breakdown-label">Laser Price:</span>
                                <span class="cost-breakdown-value" id="laserCuttingCost">$${data.stats.total_cost.toFixed(2)}</span>
                            </div>
                            <div class="cost-breakdown-item" id="excludedPartsNote" style="display: none;">
                                <span class="cost-breakdown-label">⚠️ Excluded Parts:</span>
                                <span class="cost-breakdown-value" id="excludedPartsCount">0 parts</span>
                            </div>
                            <div class="cost-breakdown-item" id="externalServicesBreakdown">
                                <!-- External services will be populated here -->
                            </div>
                            <div class="cost-breakdown-divider"></div>
                            <div class="cost-breakdown-item">
                                <span class="cost-breakdown-label">SubTotal VAT Excluded:</span>
                                <span class="cost-breakdown-value" id="subtotalVatExcluded">$${data.stats.total_cost.toFixed(2)}</span>
                            </div>
                            <div class="cost-breakdown-item">
                                <span class="cost-breakdown-label">VAT 11%:</span>
                                <span class="cost-breakdown-value" id="vatAmount">$${(data.stats.total_cost * 0.11).toFixed(2)}</span>
                            </div>
                            <div class="cost-breakdown-item total">
                                <span class="cost-breakdown-label">Total:</span>
                                <span class="cost-breakdown-value" id="totalCost">$${(data.stats.total_cost * 1.11).toFixed(2)}</span>
                            </div>
                        </div>
                    `;
                    resultsSection.appendChild(costSection);
                    
                    // Update the cost breakdown with current external services
                    setTimeout(() => {
                        updateExternalServicesTotal();
                        updateTotalCost();
                    }, 100);
                    
                    // Add PDF generation button
                    const pdfSection = document.createElement('div');
                    pdfSection.className = 'pdf-section';
                    pdfSection.innerHTML = `
                        <div class="pdf-actions">
                            <button class="pdf-btn" onclick="generatePDF()">
                                📄 Create PDF Quote
                            </button>
                        </div>
                    `;
                    resultsSection.appendChild(pdfSection);
                } else {
                    // Add cost section even if no cost data is available (for external services only)
                    const costSection = document.createElement('div');
                    costSection.className = 'cost-section';
                    costSection.innerHTML = `
                        <h3>💰 Total Project Cost</h3>
                        <div class="cost-breakdown">
                            <div class="cost-breakdown-item">
                                <span class="cost-breakdown-label">Laser Cutting Cost:</span>
                                <span class="cost-breakdown-value" id="laserCuttingCost">$0.00</span>
                            </div>
                            <div class="cost-breakdown-item" id="excludedPartsNote2" style="display: none;">
                                <span class="cost-breakdown-label">⚠️ Excluded Parts:</span>
                                <span class="cost-breakdown-value" id="excludedPartsCount2">0 parts</span>
                            </div>
                            <div class="cost-breakdown-item">
                                <span class="cost-breakdown-label">External Services:</span>
                                <span class="cost-breakdown-value" id="externalServicesCost">$0.00</span>
                            </div>
                            <div class="cost-breakdown-divider"></div>
                            <div class="cost-breakdown-item total">
                                <span class="cost-breakdown-label">Total Project Cost:</span>
                                <span class="cost-breakdown-value" id="totalCost">$0.00</span>
                            </div>
                        </div>
                    `;
                    resultsSection.appendChild(costSection);
                    
                    // Update the cost breakdown with current external services
                    setTimeout(() => {
                        updateExternalServicesTotal();
                        updateTotalCost();
                    }, 100);
                }

                // Add cost details for each part - ALL parts should have cost breakdown after Calculate Quote
                // First, add/replace breakdown for parts that have cost_data
                console.log('🔍 FRONTEND DEBUG: Received part_costs data:', data.part_costs);
                if (data.part_costs && data.part_costs.length > 0) {
                    console.log(`🔍 FRONTEND DEBUG: Rendering cost breakdown for ${data.part_costs.length} parts`);
                    data.part_costs.forEach(partCost => {
                        console.log(`🔍 FRONTEND DEBUG: Rendering part ${partCost.part_number}:`, partCost);
                        renderCostBreakdownForPart(partCost.part_number, partCost);
                    });
                } else {
                    console.log('🔍 FRONTEND DEBUG: No part_costs data received or empty array');
                }
                
                // Also ensure every part card has a cost card (fallback to empty data if needed)
                if (data.part_images) {
                    console.log(`🔍 FRONTEND DEBUG: Checking ${data.part_images.length} part images for missing cost breakdowns`);
                    data.part_images.forEach(p => {
                        const existing = document.querySelector(`[data-part="${p.part_number}"] .part-cost-info`);
                        if (!existing) {
                            console.log(`🔍 FRONTEND DEBUG: Part ${p.part_number} missing cost breakdown, adding fallback`);
                            renderCostBreakdownForPart(p.part_number, null);
                        } else {
                            console.log(`🔍 FRONTEND DEBUG: Part ${p.part_number} already has cost breakdown`);
                        }
                    });
                } else {
                    console.log('🔍 FRONTEND DEBUG: No part_images data received');
                }
            } else {
                // No parts found
                const noPartsSection = document.createElement('div');
                noPartsSection.className = 'parts-section';
                noPartsSection.innerHTML = `
                    <div class="parts-header">
                        <h3>No Parts Found</h3>
                    </div>
                    <div class="no-parts-message">
                        <p>No meaningful parts were detected in the uploaded DXF file.</p>
                    </div>
                `;
                resultsSection.appendChild(noPartsSection);
            }
            
            // Check for calculation errors and show summary
            if (data.part_costs) {
                const partsWithErrors = data.part_costs.filter(pc => pc.calculation_error);
                if (partsWithErrors.length > 0) {
                    const errorSummary = document.createElement('div');
                    errorSummary.className = 'error-summary';
                    errorSummary.innerHTML = `
                        <div class="error-summary-header">
                            <h3>⚠️ Calculation Errors Detected</h3>
                        </div>
                        <div class="error-summary-content">
                            <p><strong>${partsWithErrors.length} part(s) have calculation errors:</strong></p>
                            <ul>
                                ${partsWithErrors.map(pc => `
                                    <li><strong>Part ${pc.part_number}:</strong> ${pc.calculation_error}</li>
                                `).join('')}
                            </ul>
                            <p class="error-summary-note">
                                <strong>Note:</strong> Parts with calculation errors will not contribute to the total cost. 
                                Please fix the material information in your DXF file and re-upload.
                            </p>
                        </div>
                    `;
                    resultsSection.insertBefore(errorSummary, resultsSection.firstChild);
                }
            }
            
            // Show results
            resultsSection.style.display = 'block';
            showSuccess(`Successfully processed ${data.stats.filename}! Found ${data.stats.total_parts} parts.`);
        }

        // Render Materials Used table with inline editing and live recalculation
        async function renderMaterialsSection(data) {
            try {
                const resultsSection = document.getElementById('resultsSection');
                if (!resultsSection) return;

                // Remove ALL previous materials sections to prevent duplicates
                const prevSections = resultsSection.querySelectorAll('.materials-section');
                prevSections.forEach(section => section.remove());

                const uniqueMaterials = getUniqueMaterialsFromData(data);
                if (uniqueMaterials.length === 0) return;

                const configs = await loadMaterialConfigs(uniqueMaterials);

                const section = document.createElement('div');
                section.className = 'materials-section';
                section.innerHTML = `
                    <h3 style="margin: 16px 0 10px; text-align:center;">Materials Used</h3>
                    <div class="materials-table-wrap" style="overflow:auto; background:#fff; border-radius:12px; border:1px solid #e5e7eb;">
                        <table class="materials-table" style="width:100%; border-collapse:collapse; font-size:14px;">
                            <thead style="background:#f8f9fa;">
                                <tr>
                                    <th style="text-align:left; padding:10px;">Material</th>
                                    <th style="text-align:left; padding:10px;">Grade</th>
                                    <th style="text-align:left; padding:10px;">Finish</th>
                                    <th style="text-align:right; padding:10px;">Thickness (mm)</th>
                                    <th style="text-align:right; padding:10px;">Density (g/cm³)</th>
                                    <th style="text-align:right; padding:10px;">Price/kg</th>
                                    <th style="text-align:right; padding:10px;">Scrap Price/kg</th>
                                    <th style="text-align:right; padding:10px;">Laser Speed (m/min)</th>
                                    <th style="text-align:right; padding:10px;">Piercing (s)</th>
                                    <th style="text-align:right; padding:10px;">Vaporization (m/min)</th>
                                    <th style="text-align:right; padding:10px;">V-Groove ($/m)</th>
                                    <th style="text-align:right; padding:10px;">Bending ($/line)</th>
                                    <th style="text-align:center; padding:10px;">Edit</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                `;
                resultsSection.insertBefore(section, resultsSection.firstChild);

                const tbody = section.querySelector('tbody');
                const overrides = window.materialOverrides || (window.materialOverrides = {});

                for (const m of uniqueMaterials) {
                    const key = materialKey(m);
                    const cfg = overrides[key] || configs[key] || {};
                    const tr = document.createElement('tr');
                    tr.setAttribute('data-mkey', key);
                    tr.innerHTML = `
                        <td style="padding:10px; border-top:1px solid #eee;">${m.material_name}</td>
                        <td style="padding:10px; border-top:1px solid #eee;">${m.grade ?? ''}</td>
                        <td style="padding:10px; border-top:1px solid #eee;">${m.finish ?? ''}</td>
                        <td style="padding:10px; border-top:1px solid #eee; text-align:right;">${Number(m.thickness).toFixed(2)}</td>
                        <td style="padding:10px; border-top:1px solid #eee; text-align:right;" data-f="density">${num(cfg.density)}</td>
                        <td style="padding:10px; border-top:1px solid #eee; text-align:right;" data-f="price_per_kg">${num(cfg.price_per_kg)}</td>
                        <td style="padding:10px; border-top:1px solid #eee; text-align:right;" data-f="scrap_price_per_kg">${num(cfg.scrap_price_per_kg)}</td>
                        <td style="padding:10px; border-top:1px solid #eee; text-align:right;" data-f="machine_speed">${num(cfg.machine_speed)}</td>
                        <td style="padding:10px; border-top:1px solid #eee; text-align:right;" data-f="piercing_time">${num(cfg.piercing_time)}</td>
                        <td style="padding:10px; border-top:1px solid #eee; text-align:right;" data-f="vaporization_speed">${num(cfg.vaporization_speed)}</td>
                        <td style="padding:10px; border-top:1px solid #eee; text-align:right;" data-f="vgroove_price">${num(cfg.vgroove_price)}</td>
                        <td style="padding:10px; border-top:1px solid #eee; text-align:right;" data-f="bending_price">${num(cfg.bending_price)}</td>
                        <td style="padding:10px; border-top:1px solid #eee; text-align:center;">
                            <button class="edit-btn" style="border:none; background:#fff; cursor:pointer; font-size:16px;" title="Edit">🖊️</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                }

                // Delegate edit handling
                tbody.addEventListener('click', (e) => {
                    const btn = e.target.closest('.edit-btn');
                    if (!btn) return;
                    const tr = btn.closest('tr');
                    const key = tr.getAttribute('data-mkey');
                    const editing = tr.classList.toggle('editing');
                    if (editing) {
                        btn.textContent = '💾';
                        makeEditable(tr, /*allowDensity*/ false);
                    } else {
                        btn.textContent = '🖊️';
                        const values = readEditedValues(tr);
                        // Persist in session (frontend only) and recompute
                        window.materialOverrides[key] = { ...(configs[key]||{}), ...values };
                        applyMaterialOverrides();
                        makeReadOnly(tr, window.materialOverrides[key]);
                    }
                });

                // After rendering, if there are existing overrides, immediately apply them
                try {
                    if (window.materialOverrides && Object.keys(window.materialOverrides).length > 0) {
                        applyMaterialOverrides();
                    }
                } catch (e) { console.warn('auto apply overrides failed', e); }
            } catch (err) {
                console.warn('renderMaterialsSection error', err);
            }
        }

        function materialKey(m) {
            return [String(m.material_name||''), String(m.thickness||''), String(m.grade??''), String(m.finish??'')].join('|');
        }

        function getUniqueMaterialsFromData(data) {
            const set = new Set();
            const list = [];
            // Prefer detailed part_costs when present
            const src = Array.isArray(data.part_costs) ? data.part_costs : [];
            for (const pc of src) {
                const m = {
                    material_name: pc.applied_material_name || (pc.extracted_label && pc.extracted_label.material_name) || '',
                    thickness: pc.applied_thickness != null ? pc.applied_thickness : (pc.extracted_label && pc.extracted_label.thickness),
                    grade: pc.applied_grade != null ? pc.applied_grade : (pc.extracted_label && pc.extracted_label.grade),
                    finish: pc.applied_finish != null ? pc.applied_finish : (pc.extracted_label && pc.extracted_label.finish)
                };
                if (!m.material_name || m.thickness == null) continue;
                const key = materialKey(m);
                if (set.has(key)) continue;
                set.add(key);
                list.push(m);
            }

            // If no materials found from part_costs (e.g., analyze_only stripped pricing), fallback to part_labels
            if (list.length === 0 && data && data.part_labels) {
                const labels = data.part_labels;
                const keys = Object.keys(labels).sort((a,b)=>parseInt(a)-parseInt(b));
                for (const k of keys) {
                    const lbl = labels[k];
                    if (!lbl) continue;
                    const m = {
                        material_name: lbl.material_name || '',
                        thickness: lbl.thickness,
                        grade: lbl.grade,
                        finish: lbl.finish
                    };
                    if (!m.material_name || m.thickness == null) continue;
                    const id = materialKey(m);
                    if (set.has(id)) continue;
                    set.add(id);
                    list.push(m);
                }
            }

            // Final fallback: use top-level material if present
            if (list.length === 0 && data) {
                const m = {
                    material_name: data.material_name || '',
                    thickness: data.thickness,
                    grade: data.grade,
                    finish: data.finish
                };
                if (m.material_name && m.thickness != null) {
                    list.push(m);
                }
            }
            return list;
        }

        async function loadMaterialConfigs(materials) {
            const out = {};
            await Promise.all(materials.map(async (m) => {
                const qs = new URLSearchParams({
                    material_name: m.material_name,
                    thickness: String(m.thickness),
                    grade: m.grade != null ? String(m.grade) : '',
                    finish: m.finish != null ? String(m.finish) : ''
                });
                try {
                    const res = await fetch(`/api/materials/config?${qs.toString()}`);
                    if (res.ok) {
                        const cfg = await res.json();
                        out[materialKey(m)] = cfg || {};
                    } else {
                        out[materialKey(m)] = {};
                    }
                } catch { out[materialKey(m)] = {}; }
            }));
            return out;
        }

        function makeEditable(tr, allowDensity) {
            tr.querySelectorAll('[data-f]').forEach(td => {
                const field = td.getAttribute('data-f');
                if (!allowDensity && field === 'density') return; // density read-only by default
                const val = td.textContent.trim();
                td.innerHTML = `<input type="number" step="0.0001" value="${val||''}" style="width:110px; padding:6px 8px; border:1px solid #e5e7eb; border-radius:6px; text-align:right;">`;
            });
        }

        function makeReadOnly(tr, cfg) {
            tr.querySelectorAll('[data-f]').forEach(td => {
                const field = td.getAttribute('data-f');
                td.textContent = num(cfg && cfg[field]);
            });
        }

        function readEditedValues(tr) {
            const vals = {};
            tr.querySelectorAll('[data-f]').forEach(td => {
                const field = td.getAttribute('data-f');
                const inp = td.querySelector('input');
                if (!inp) return;
                const v = parseFloat(inp.value);
                if (!isNaN(v)) vals[field] = v;
            });
            return vals;
        }

        function num(v) { return (v == null || isNaN(v)) ? '' : Number(v).toFixed(3).replace(/\.000$/, '.0'); }

        function applyMaterialOverrides() {
            try {
                const overrides = window.materialOverrides || {};
                if (!window.currentData || !Array.isArray(window.currentData.part_costs)) return;
                for (const pc of window.currentData.part_costs) {
                    const key = [String(pc.applied_material_name||''), String(pc.applied_thickness||''), String(pc.applied_grade??''), String(pc.applied_finish??'')].join('|');
                    const ov = overrides[key];
                    if (!ov) continue;
                    const cd = pc.cost_data || {};
                    // Derive constants
                    const area_m2 = (cd.area_sq_mm || 0) / 1e6;
                    const thickness_mm = parseFloat(pc.applied_thickness || 0) || 0;
                    const thickness_m = thickness_mm / 1000.0;
                    const perimeter_m = cd.perimeter_meters || 0;
                    const parts_count = parseInt(pc.object_parts_count || 0) || 0;

                    // Laser cost rate from existing data
                    const time_min_orig = (cd.total_time_min || 0);
                    const laser_cost_rate = time_min_orig > 0 ? (cd.laser_cost || 0) / time_min_orig : 0;

                    // Recompute times
                    const ms = parseFloat(ov.machine_speed || cd.machine_speed) || (cd.cutting_time_machine > 0 && perimeter_m > 0 ? (perimeter_m / cd.cutting_time_machine) : 100.0);
                    const vs = parseFloat(ov.vaporization_speed || cd.vaporization_speed) || (cd.cutting_time_vaporization > 0 && perimeter_m > 0 ? (perimeter_m / cd.cutting_time_vaporization) : 50.0);
                    const pt_sec = parseFloat(ov.piercing_time || 0);
                    const ct_machine = ms > 0 ? (perimeter_m / ms) : 0;
                    const ct_vap = vs > 0 ? (perimeter_m / vs) : 0;
                    const pt_total = parts_count * (pt_sec / 60.0);
                    const total_time_min = ct_machine + ct_vap + pt_total;
                    const laser_cost = laser_cost_rate * total_time_min;

                    // Material cost: use UI scrap factor and allow overriding scrap price/kg
                    const orig_density = inferOriginalDensityForPart(pc) || 7.85; // g/cm3
                    const orig_price = inferOriginalPriceForPart(pc) || 25.0;
                    const orig_scrap_price = inferOriginalScrapPriceForPart(pc) || 0.0;
                    const density_new = (ov.density != null ? ov.density : orig_density);
                    const price_new = (ov.price_per_kg != null ? ov.price_per_kg : orig_price);
                    const scrap_price_new = (ov.scrap_price_per_kg != null ? ov.scrap_price_per_kg : orig_scrap_price);
                    const scrap_factor = (function(){
                        const val = parseFloat(document.getElementById('scrapFactor') && document.getElementById('scrapFactor').value);
                        return (isNaN(val) || val <= 0) ? 1.20 : val;
                    })();
                    // Weight in kg
                    const weight_kg = area_m2 * thickness_m * (density_new * 1000.0);
                    const material_price = weight_kg * price_new;
                    const material_cost_before_scrap = material_price * scrap_factor;
                    const scrap_weight = weight_kg * Math.max(0, (scrap_factor - 1));
                    const scrap_cost = scrap_weight * (scrap_price_new || 0);
                    const material_cost = material_cost_before_scrap - scrap_cost;

                    // Bending & V-groove
                    const vgroove_len = cd.vgroove_length_meters || 0;
                    const vgroove_price = ov.vgroove_price != null ? ov.vgroove_price : 0;
                    const bending_lines = cd.total_bending_lines || 0;
                    const bending_price = ov.bending_price != null ? ov.bending_price : 0;
                    const vgroove_cost = vgroove_len * vgroove_price;
                    const bending_cost = bending_lines * bending_price;

                    const total_cost = (laser_cost || 0) + (material_cost || 0) + (vgroove_cost || 0) + (bending_cost || 0);

                    // Write back
                    pc.cost_data = {
                        ...pc.cost_data,
                        cutting_time_machine: ct_machine,
                        cutting_time_vaporization: ct_vap,
                        piercing_time_total: pt_total,
                        total_time_min: total_time_min,
                        laser_cost: laser_cost,
                        material_cost: material_cost,
                        vgroove_cost: vgroove_cost,
                        bending_cost: bending_cost,
                        total_cost: total_cost
                    };
                }
                // Refresh UI
                document.querySelectorAll('.part-card').forEach(card => {
                    const pn = parseInt(card.getAttribute('data-part'));
                    if (!isNaN(pn)) { updateCostForPart(pn); }
                });
                updateTotalCost();

                // Also reflect differences in the Materials Used table rows if overrides differ from DB values
                try {
                    const tbody = document.querySelector('.materials-table tbody');
                    if (tbody) {
                        tbody.querySelectorAll('tr').forEach(tr => {
                            const key = tr.getAttribute('data-mkey');
                            const ov = overrides[key];
                            const base = {};
                            tr.querySelectorAll('[data-f]').forEach(td => {
                                const f = td.getAttribute('data-f');
                                // If this cell currently shows an input (editing), read its value; else text
                                const inp = td.querySelector('input');
                                const val = inp ? parseFloat(inp.value) : parseFloat(td.textContent);
                                base[f] = isNaN(val) ? null : val;
                            });
                            if (ov) {
                                let changed = false;
                                ['price_per_kg','scrap_price_per_kg','machine_speed','piercing_time','vaporization_speed','vgroove_price','bending_price'].forEach(f => {
                                    if (ov[f] != null && (base[f] == null || Math.abs(Number(ov[f]) - Number(base[f])) > 1e-9)) {
                                        changed = true;
                                    }
                                });
                                tr.style.backgroundColor = changed ? '#fff8e1' : '';
                            } else {
                                tr.style.backgroundColor = '';
                            }
                        });
                    }
                } catch {}
            } catch (e) { console.warn('applyMaterialOverrides failed', e); }
        }

        function inferOriginalDensityForPart(pc) {
            try {
                const m = {
                    material_name: pc.applied_material_name,
                    thickness: pc.applied_thickness,
                    grade: pc.applied_grade,
                    finish: pc.applied_finish
                };
                const key = materialKey(m);
                const tableRow = document.querySelector(`tr[data-mkey="${CSS.escape(key)}"]`);
                if (!tableRow) return null;
                // The first render uses DB config (before edit). We stored it in cell text
                const td = tableRow.querySelector('[data-f="density"]');
                const v = td && td.textContent ? parseFloat(td.textContent) : null;
                return isNaN(v) ? null : v;
            } catch { return null; }
        }

        function inferOriginalPriceForPart(pc) {
            try {
                const m = {
                    material_name: pc.applied_material_name,
                    thickness: pc.applied_thickness,
                    grade: pc.applied_grade,
                    finish: pc.applied_finish
                };
                const key = materialKey(m);
                const tableRow = document.querySelector(`tr[data-mkey="${CSS.escape(key)}"]`);
                if (!tableRow) return null;
                const td = tableRow.querySelector('[data-f="price_per_kg"]');
                const v = td && td.textContent ? parseFloat(td.textContent) : null;
                return isNaN(v) ? null : v;
            } catch { return null; }
        }

        function inferOriginalScrapPriceForPart(pc) {
            try {
                const m = {
                    material_name: pc.applied_material_name,
                    thickness: pc.applied_thickness,
                    grade: pc.applied_grade,
                    finish: pc.applied_finish
                };
                const key = materialKey(m);
                const tableRow = document.querySelector(`tr[data-mkey="${CSS.escape(key)}"]`);
                if (!tableRow) return null;
                const td = tableRow.querySelector('[data-f="scrap_price_per_kg"]');
                const v = td && td.textContent ? parseFloat(td.textContent) : null;
                return isNaN(v) ? null : v;
            } catch { return null; }
        }

        // Auto-fill main Material Selection from first extracted label
        function autoFillFromExtractedLabels(data) {
            try {
                const map = data && data.part_labels ? data.part_labels : null;
                if (!map) return;
                const keys = Object.keys(map).map(k => parseInt(k)).sort((a,b)=>a-b);
                for (const k of keys) {
                    const entry = map[k];
                    if (!entry) continue;
                    const mat = entry.material_name || '';
                    const th = (entry.thickness != null) ? String(entry.thickness) : '';
                    const gr = (entry.grade != null) ? String(entry.grade) : '';
                    const fi = entry.finish || '';
                    if (mat || th || gr || fi) {
                        // Fill dropdowns if empty
                        const matSel = document.getElementById('materialTypeSelect');
                        const thSel = document.getElementById('thicknessSelect');
                        const grSel = document.getElementById('gradeSelect');
                        const fiSel = document.getElementById('finishSelect');
                        if (matSel && !matSel.value && mat) matSel.value = mat;
                        if (thSel && !thSel.value && th) thSel.value = th;
                        if (grSel && !grSel.value && gr) grSel.value = gr;
                        if (fiSel && !fiSel.value && fi) fiSel.value = fi;
                        break;
                    }
                }
            } catch {}
        }

        // Check if any parts are missing material information
        function checkMissingMaterials(data) {
            const missingMaterials = [];
            const partLabels = data && data.part_labels ? data.part_labels : {};
            
            Object.keys(partLabels).forEach(partNumber => {
                const label = partLabels[partNumber];
                if (!label) return;
                
                const hasMaterial = label.material_name && label.material_name.trim() !== '';
                const hasThickness = label.thickness != null && label.thickness !== '';
                let hasGrade = label.grade != null && label.grade !== '';
                let hasFinish = label.finish && String(label.finish).trim() !== '';

                // Materials that do not require grade/finish (treat as satisfied)
                const matLower = (label.material_name || '').trim().toLowerCase();
                const noGf = new Set(['mild steel', 'steel', 'ms', 'aluminum', 'aluminium', 'alu', 'copper']);
                if (noGf.has(matLower)) {
                    hasGrade = true;
                    hasFinish = true;
                }
                
                if (!hasMaterial || !hasThickness || !hasGrade || !hasFinish) {
                    missingMaterials.push({
                        partNumber: parseInt(partNumber),
                        label: label,
                        missing: {
                            material: !hasMaterial,
                            thickness: !hasThickness,
                            grade: !hasGrade,
                            finish: !hasFinish
                        }
                    });
                }
            });
            
            return missingMaterials;
        }

        // Show material selection popup
        function showMaterialPopup(missingMaterials, data) {
            const popup = document.getElementById('materialPopup');
            const partsContainer = document.getElementById('materialPopupParts');
            
            // Clear previous content
            partsContainer.innerHTML = '';
            
            // Create material selection for each missing part
            missingMaterials.forEach(part => {
                const partElement = document.createElement('div');
                partElement.className = 'material-popup-part';
                partElement.dataset.partNumber = part.partNumber;
                
                const isComplete = !part.missing.material && !part.missing.thickness && 
                                 !part.missing.grade && !part.missing.finish;
                
                partElement.innerHTML = `
                    <div class="material-popup-part-header">
                        <div class="material-popup-part-title">Part ${part.partNumber}</div>
                        <div class="material-popup-part-status ${isComplete ? 'complete' : 'incomplete'}">
                            ${isComplete ? 'Complete' : 'Incomplete'}
                        </div>
                    </div>
                    <div class="material-popup-part-fields">
                        <div class="material-popup-part-image" id="popup_img_${part.partNumber}">Loading…</div>
                        <div class="material-popup-field">
                            <label for="popup_material_${part.partNumber}">Material Type: <span style="color: #666; font-size: 12px;">(Optional)</span></label>
                            <select id="popup_material_${part.partNumber}" class="popup-material-select" data-part="${part.partNumber}" data-field="material">
                                <option value="">Select Material Type (Optional)</option>
                            </select>
                        </div>
                        <div class="material-popup-field">
                            <label for="popup_thickness_${part.partNumber}">Thickness:</label>
                            <select id="popup_thickness_${part.partNumber}" class="popup-thickness-select" data-part="${part.partNumber}" data-field="thickness">
                                <option value="">Select Material Type First</option>
                            </select>
                        </div>
                        <div class="material-popup-field">
                            <label for="popup_grade_${part.partNumber}">Grade:</label>
                            <select id="popup_grade_${part.partNumber}" class="popup-grade-select" data-part="${part.partNumber}" data-field="grade">
                                <option value="">Select Material Type First</option>
                            </select>
                        </div>
                        <div class="material-popup-field">
                            <label for="popup_finish_${part.partNumber}">Finish:</label>
                            <select id="popup_finish_${part.partNumber}" class="popup-finish-select" data-part="${part.partNumber}" data-field="finish">
                                <option value="">Select Material Type First</option>
                            </select>
                        </div>
                    </div>
                `;
                
                partsContainer.appendChild(partElement);
            });
            
            // Populate dropdowns with available options
            populatePopupDropdowns();
            
            // Pre-fill with existing values if available (async)
            prefillPopupValues(missingMaterials).catch(e => console.warn('Prefill failed', e));

            // Inject part thumbnails next to the dropdowns
            try {
                const imagesMap = new Map((data.part_images || []).map(p => [parseInt(p.part_number), p.image]));
                missingMaterials.forEach(part => {
                    const imgWrap = document.getElementById(`popup_img_${part.partNumber}`);
                    if (!imgWrap) return;
                    const b64 = imagesMap.get(parseInt(part.partNumber));
                    if (b64) {
                        imgWrap.innerHTML = `<img src="data:image/png;base64,${b64}" alt="Part ${part.partNumber}">`;
                    } else {
                        imgWrap.textContent = 'No preview';
                    }
                });
            } catch (err) { console.warn('material popup images failed', err); }
            
            // Add event listeners for cascading dropdowns
            setupPopupDropdownListeners();
            
            // Store data for later use
            window.__popupData = data;
            window.__missingMaterials = missingMaterials;
            
            // Show popup
            popup.style.display = 'flex';
        }

        // Populate popup dropdowns with available options
        async function populatePopupDropdowns() {
            try {
                const response = await fetch('/api/materials');
                const materials = await response.json();
                
                if (materials.success) {
                    const materialTypes = materials.material_types || [];
                    
                    // Populate material type dropdowns only
                    document.querySelectorAll('.popup-material-select').forEach(select => {
                        materialTypes.forEach(material => {
                            const option = document.createElement('option');
                            option.value = material;
                            option.textContent = material;
                            select.appendChild(option);
                        });
                    });
                    
                    // Store options for cascading dropdowns
                    window.__popupOptions = {
                        materialTypes,
                        filteredOptions: materials.filtered_options || {}
                    };
                }
            } catch (error) {
                console.error('Error loading materials:', error);
            }
        }

        // Pre-fill popup values with existing data
        async function prefillPopupValues(missingMaterials) {
            for (const part of missingMaterials) {
                const label = part.label;
                
                if (label.material_name) {
                    const materialSelect = document.getElementById(`popup_material_${part.partNumber}`);
                    if (materialSelect) {
                        materialSelect.value = label.material_name;
                        // Trigger cascading update for thickness/grade/finish
                        await updatePopupFilteredOptions(part.partNumber, 'material');
                    }
                }
                
                if (label.thickness != null) {
                    const thicknessSelect = document.getElementById(`popup_thickness_${part.partNumber}`);
                    if (thicknessSelect) {
                        thicknessSelect.value = String(label.thickness);
                        // Trigger cascading update for grade/finish
                        await updatePopupFilteredOptions(part.partNumber, 'thickness');
                    }
                }
                
                if (label.grade != null) {
                    const gradeSelect = document.getElementById(`popup_grade_${part.partNumber}`);
                    if (gradeSelect) {
                        gradeSelect.value = String(label.grade);
                        // Trigger cascading update for finish
                        await updatePopupFilteredOptions(part.partNumber, 'grade');
                    }
                }
                
                if (label.finish) {
                    const finishSelect = document.getElementById(`popup_finish_${part.partNumber}`);
                    if (finishSelect) {
                        finishSelect.value = label.finish;
                    }
                }

                // Auto-assign grade/finish to 0 for Steel/Mild Steel
                try {
                    const mat = (label.material_name || '').trim().toLowerCase();
                    if (['mild steel','steel','ms'].includes(mat)) {
                        const gradeSelect = document.getElementById(`popup_grade_${part.partNumber}`);
                        const finishSelect = document.getElementById(`popup_finish_${part.partNumber}`);
                        if (gradeSelect) {
                            if (![...gradeSelect.options].some(o => o.value === '0')) {
                                const opt = document.createElement('option'); opt.value = '0'; opt.textContent = '0'; gradeSelect.prepend(opt);
                            }
                            gradeSelect.value = '0';
                        }
                        if (finishSelect) {
                            if (![...finishSelect.options].some(o => o.value === '0')) {
                                const opt = document.createElement('option'); opt.value = '0'; opt.textContent = '0'; finishSelect.prepend(opt);
                            }
                            finishSelect.value = '0';
                        }
                    }
                } catch {}
            }
        }

        // Setup popup dropdown listeners for cascading behavior
        function setupPopupDropdownListeners() {
            document.querySelectorAll('.popup-material-select').forEach(select => {
                select.addEventListener('change', function() {
                    const partNumber = this.dataset.part;
                    updatePopupFilteredOptions(partNumber, 'material');
                });
            });
            
            document.querySelectorAll('.popup-thickness-select').forEach(select => {
                select.addEventListener('change', function() {
                    const partNumber = this.dataset.part;
                    updatePopupFilteredOptions(partNumber, 'thickness');
                });
            });
            
            document.querySelectorAll('.popup-grade-select').forEach(select => {
                select.addEventListener('change', function() {
                    const partNumber = this.dataset.part;
                    updatePopupFilteredOptions(partNumber, 'grade');
                });
            });
        }

        // Update filtered options for popup dropdowns
        async function updatePopupFilteredOptions(partNumber, changedField) {
            const materialSelect = document.getElementById(`popup_material_${partNumber}`);
            const thicknessSelect = document.getElementById(`popup_thickness_${partNumber}`);
            const gradeSelect = document.getElementById(`popup_grade_${partNumber}`);
            const finishSelect = document.getElementById(`popup_finish_${partNumber}`);
            
            const material = materialSelect ? materialSelect.value : '';
            const thickness = thicknessSelect ? thicknessSelect.value : '';
            const grade = gradeSelect ? gradeSelect.value : '';
            
            try {
                const response = await fetch('/api/filtered-options', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        material_name: material,
                        thickness: thickness,
                        grade: grade
                    })
                });
                
                const data = await response.json();
                console.log('Filtered options response:', data);
                
                if (data.success) {
                    // Update thickness options
                    if (changedField === 'material' && thicknessSelect) {
                        updateSelectOptions(thicknessSelect, data.thicknesses || []);
                        // Clear dependent fields when material changes
                        if (gradeSelect) gradeSelect.value = '';
                        if (finishSelect) finishSelect.value = '';
                    }
                    
                    // Update grade options
                    if ((changedField === 'material' || changedField === 'thickness') && gradeSelect) {
                        updateSelectOptions(gradeSelect, data.grades || []);
                        // Clear finish when grade changes
                        if (changedField === 'grade' && finishSelect) finishSelect.value = '';
                    }
                    
                    // Update finish options
                    if (finishSelect) {
                        updateSelectOptions(finishSelect, data.finishes || []);
                    }

                    // Auto-assign for Steel/Mild Steel in popup: force grade/finish to '0'
                    const matLower = (material || '').trim().toLowerCase();
                    if (['mild steel','steel','ms'].includes(matLower)) {
                        if (gradeSelect) {
                            if (![...gradeSelect.options].some(o => o.value === '0')) {
                                const opt = document.createElement('option'); opt.value = '0'; opt.textContent = '0'; gradeSelect.prepend(opt);
                            }
                            gradeSelect.value = '0';
                        }
                        if (finishSelect) {
                            if (![...finishSelect.options].some(o => o.value === '0')) {
                                const opt = document.createElement('option'); opt.value = '0'; opt.textContent = '0'; finishSelect.prepend(opt);
                            }
                            finishSelect.value = '0';
                        }
                    }
                } else {
                    console.error('Failed to get filtered options:', data.error);
                }
            } catch (error) {
                console.error('Error updating filtered options:', error);
            }
        }

        // Helper function to update select options
        function updateSelectOptions(select, options) {
            const currentValue = select.value;
            select.innerHTML = '<option value="">Select...</option>';
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
            
            // Restore previous value if it's still valid
            if (currentValue && options.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        // Apply material selections and proceed with analysis
        function applyMaterialSelections() {
            const missingMaterials = window.__missingMaterials || [];
            const data = window.__popupData;
            
            // Update the part labels with user selections
            const updatedPartLabels = { ...data.part_labels };
            let hasErrors = false;
            
            missingMaterials.forEach(part => {
                const materialSelect = document.getElementById(`popup_material_${part.partNumber}`);
                const thicknessSelect = document.getElementById(`popup_thickness_${part.partNumber}`);
                const gradeSelect = document.getElementById(`popup_grade_${part.partNumber}`);
                const finishSelect = document.getElementById(`popup_finish_${part.partNumber}`);
                
                const errId = `popup_err_${part.partNumber}`;
                const ensureErr = () => {
                    const parent = document.querySelector(`.material-popup-part[data-part-number="${part.partNumber}"] .material-popup-part-fields`) || document.getElementById(`popup_finish_${part.partNumber}`)?.closest('.material-popup-part-fields');
                    if (!parent) return null;
                    let el = document.getElementById(errId);
                    if (!el) {
                        el = document.createElement('div');
                        el.id = errId;
                        el.className = 'material-popup-error';
                        parent.appendChild(el);
                    }
                    return el;
                };
                
                if (updatedPartLabels[part.partNumber]) {
                    if (materialSelect && materialSelect.value) {
                        updatedPartLabels[part.partNumber].material_name = materialSelect.value;
                    }
                    if (thicknessSelect && thicknessSelect.value) {
                        updatedPartLabels[part.partNumber].thickness = parseFloat(thicknessSelect.value);
                    }
                    const matLower = ((updatedPartLabels[part.partNumber].material_name || '').trim().toLowerCase());
                    const isSteel = ['mild steel','steel','ms'].includes(matLower);
                    if (isSteel) {
                        updatedPartLabels[part.partNumber].grade = 0;
                        updatedPartLabels[part.partNumber].finish = '0';
                    } else {
                        if (gradeSelect && gradeSelect.value) {
                            updatedPartLabels[part.partNumber].grade = gradeSelect.value;
                        }
                        if (finishSelect && finishSelect.value) {
                            updatedPartLabels[part.partNumber].finish = finishSelect.value;
                        }
                    }
                    
                    const lbl = updatedPartLabels[part.partNumber];
                    const missing = [];
                    
                    // Only check for required fields if material is selected
                    if (lbl.material_name) {
                        if (lbl.thickness == null || lbl.thickness === '') missing.push('Thickness');
                        // Do not require Grade/Finish for Steel/Mild Steel
                        if (!isSteel) {
                            if (lbl.grade == null || lbl.grade === '') missing.push('Grade');
                            if (!lbl.finish) missing.push('Finish');
                        }
                    }
                    
                    const errEl = ensureErr();
                    if (errEl) {
                        if (missing.length > 0) {
                            errEl.textContent = `Please select: ${missing.join(', ')}`;
                            hasErrors = true;
                        } else {
                            errEl.textContent = '';
                            errEl.remove();
                        }
                    }
                }
            });
            
            // If any error remains, keep popup open
            if (hasErrors) {
                return;
            }
            
            // Update the data object
            data.part_labels = updatedPartLabels;
            
            // Update the global currentData as well
            window.currentData = data;
            
            // Update part_costs with the new material information for calculations
            updatePartCostsWithMaterialInfo(data, updatedPartLabels);
            
            // Update part cards with new material information
            updatePartCardsWithMaterialInfo(data);
            
            // Close popup
            closeMaterialPopup();
            
            // Proceed with normal flow
            try { autoFillFromExtractedLabels(data); } catch(e) { console.warn('Auto-fill labels failed', e); }
            
            // Remember last upload params for final quote
            const file = window.__lastFile;
            window.__lastUploadParams = { 
                single: true, 
                fileName: file.name, 
                materialType: document.getElementById('materialTypeSelect').value, 
                thickness: document.getElementById('thicknessSelect').value, 
                grade: document.getElementById('gradeSelect').value, 
                finish: document.getElementById('finishSelect').value 
            };
            
            // Show results
            showResults(data);
            
            // Show success message with instruction to calculate quote
            const successMessage = document.getElementById('successMessage');
            successMessage.textContent = 'Materials applied successfully. Click "Calculate Quote" to see the cost breakdown for each part.';
            successMessage.style.display = 'block';
            setTimeout(() => { successMessage.style.display = 'none'; }, 5000);
        }

        // Update part cards with material information after material selection
        function updatePartCardsWithMaterialInfo(data) {
            try {
                // Update each part card with the new material information
                const partCards = document.querySelectorAll('.part-card');
                
                partCards.forEach(partCard => {
                    const partNumber = parseInt(partCard.getAttribute('data-part'));
                    if (isNaN(partNumber)) return;
                    
                    const label = data.part_labels && data.part_labels[partNumber] ? data.part_labels[partNumber] : {};
                    
                    // Get material information
                    const matText = label.material_name || '';
                    const thText = label.thickness != null ? `${label.thickness} mm` : '';
                    const gfText = [label.grade != null ? String(label.grade) : '', label.finish || ''].filter(Boolean).join(' / ');
                    
                    // Find the part-stats section in this card
                    const partStats = partCard.querySelector('.part-stats');
                    if (!partStats) return;
                    
                    // Remove existing material info sections
                    const existingExtracted = partStats.querySelector('.material-extracted-info');
                    const existingParsed = partStats.querySelector('.material-parsed-info');
                    if (existingExtracted) existingExtracted.remove();
                    if (existingParsed) existingParsed.remove();
                    
                    // Add new material information sections
                    if (matText || thText || gfText) {
                        const materialInfo = document.createElement('div');
                        materialInfo.className = 'material-parsed-info';
                        materialInfo.style.marginTop = '4px';
                        materialInfo.innerHTML = `
                            <div class="area-info" style="margin-top:4px;">
                                <div class="area-number" style="font-size:0.9em;">${[matText, thText, gfText].filter(Boolean).join(' · ')}</div>
                                <div class="area-label">Parsed</div>
                            </div>
                        `;
                        
                        // Insert after the L x W info
                        const lxwInfo = partStats.querySelector('.area-info:last-of-type');
                        if (lxwInfo) {
                            lxwInfo.insertAdjacentElement('afterend', materialInfo);
                        } else {
                            partStats.appendChild(materialInfo);
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error updating part cards with material info:', error);
            }
        }

        // Update part_costs with material information for calculations
        function updatePartCostsWithMaterialInfo(data, updatedPartLabels) {
            try {
                if (!data.part_costs || !Array.isArray(data.part_costs)) {
                    console.warn('No part_costs array found in data');
                    return;
                }
                
                // Update each part cost entry with the new material information
                data.part_costs.forEach(partCost => {
                    const partNumber = partCost.part_number;
                    const label = updatedPartLabels[partNumber];
                    
                    if (label) {
                        // Update the applied material fields for cost calculations
                        if (label.material_name) {
                            partCost.applied_material_name = label.material_name;
                        }
                        if (label.thickness != null) {
                            partCost.applied_thickness = label.thickness;
                        }
                        if (label.grade != null) {
                            partCost.applied_grade = label.grade;
                        }
                        if (label.finish != null) {
                            partCost.applied_finish = label.finish;
                        }
                        
                        // Clear any previous calculation errors since we now have material info
                        if (partCost.calculation_error) {
                            delete partCost.calculation_error;
                        }
                        
                        // If we have material and thickness, we can recalculate costs
                        if (label.material_name && label.thickness != null) {
                            // Trigger cost recalculation for this part
                            recalculatePartCost(partCost, label);
                        }
                    }
                });
                
                // Update the global data
                window.currentData = data;
                
                // Update cost displays for all parts
                updateAllPartCosts();
                
            } catch (error) {
                console.error('Error updating part costs with material info:', error);
            }
        }

        // Recalculate cost for a single part with new material information
        function recalculatePartCost(partCost, materialInfo) {
            try {
                // This is a simplified cost recalculation
                // In a full implementation, you might want to call the backend
                // For now, we'll update the cost_data if it exists
                if (partCost.cost_data) {
                    // Mark that this part has been updated with new material info
                    partCost.cost_data.material_updated = true;
                    partCost.cost_data.applied_material_name = materialInfo.material_name;
                    partCost.cost_data.applied_thickness = materialInfo.thickness;
                    partCost.cost_data.applied_grade = materialInfo.grade;
                    partCost.cost_data.applied_finish = materialInfo.finish;
                }
            } catch (error) {
                console.error('Error recalculating part cost:', error);
            }
        }

        // Update cost displays for all parts
        function updateAllPartCosts() {
            try {
                // Update cost displays for each part card
                document.querySelectorAll('.part-card').forEach(card => {
                    const partNumber = parseInt(card.getAttribute('data-part'));
                    if (!isNaN(partNumber)) {
                        updateCostForPart(partNumber);
                    }
                });
                
                // Update total cost
                updateTotalCost();
                
            } catch (error) {
                console.error('Error updating all part costs:', error);
            }
        }

        // Close material popup
        function closeMaterialPopup() {
            const popup = document.getElementById('materialPopup');
            popup.style.display = 'none';
            
            // Clear stored data
            window.__popupData = null;
            window.__missingMaterials = null;
        }

        // Close popup when clicking outside or pressing Escape
        document.addEventListener('DOMContentLoaded', function() {
            const popup = document.getElementById('materialPopup');
            if (popup) {
                popup.addEventListener('click', function(e) {
                    if (e.target === popup) {
                        closeMaterialPopup();
                    }
                });
            }
            
            // Close popup with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const popup = document.getElementById('materialPopup');
                    if (popup && popup.style.display === 'flex') {
                        closeMaterialPopup();
                    }
                }
            });
        });

        // Final quote: recompute using stored file and updated scrap factor
        // calculateQuoteAfterNest function removed - will be replaced with new implementation

        // Long-press functionality for counter buttons
        let longPressTimer = null;
        let longPressInterval = null;
        let isLongPressActive = false;
        let lastPressTime = 0;
        const LONG_PRESS_DELAY = 500; // 500ms to trigger long press
        const LONG_PRESS_INTERVAL = 100; // 100ms interval for continuous increment/decrement
        const LONG_PRESS_INCREMENT = 10; // Increment by 10 for long press
        const SHORT_PRESS_THRESHOLD = 200; // 200ms threshold for short press

        function setupLongPressCounters() {
            document.querySelectorAll('.counter-btn').forEach(button => {
                const partNumber = parseInt(button.dataset.part);
                const action = button.dataset.action;
                
                // Mouse events for desktop
                button.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    startLongPress(partNumber, action, button);
                });
                
                button.addEventListener('mouseup', () => {
                    stopLongPress();
                });
                
                button.addEventListener('mouseleave', () => {
                    stopLongPress();
                });
                
                // Touch events for mobile
                button.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    startLongPress(partNumber, action, button);
                });
                
                button.addEventListener('touchend', () => {
                    stopLongPress();
                });
                
                button.addEventListener('touchcancel', () => {
                    stopLongPress();
                });
                
                // Click event for immediate response
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    const currentTime = Date.now();
                    const pressDuration = currentTime - lastPressTime;
                    
                    // If it was a short press (not a long press), increment/decrement by 1
                    if (pressDuration < SHORT_PRESS_THRESHOLD && !isLongPressActive) {
                        if (action === 'increase') {
                            increasePieceCount(partNumber);
                        } else {
                            decreasePieceCount(partNumber);
                        }
                    }
                });
            });
        }

        function startLongPress(partNumber, action, button) {
            // Record press start time
            lastPressTime = Date.now();
            
            // Clear any existing timers
            stopLongPress();
            
            // Start long press timer
            longPressTimer = setTimeout(() => {
                // Long press detected - start continuous increment/decrement
                isLongPressActive = true;
                longPressInterval = setInterval(() => {
                    if (action === 'increase') {
                        increasePieceCountBy(partNumber, LONG_PRESS_INCREMENT);
                    } else {
                        decreasePieceCountBy(partNumber, LONG_PRESS_INCREMENT);
                    }
                }, LONG_PRESS_INTERVAL);
                
                // Add visual feedback
                button.classList.add('long-press');
            }, LONG_PRESS_DELAY);
        }

        function stopLongPress() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
            if (longPressInterval) {
                clearInterval(longPressInterval);
                longPressInterval = null;
            }
            
            // Reset long press state
            isLongPressActive = false;
            
            // Reset visual feedback
            document.querySelectorAll('.counter-btn').forEach(button => {
                button.classList.remove('long-press');
            });
        }

        function increasePieceCount(partNumber) {
            const partCard = document.querySelector(`.part-card[data-part="${partNumber}"]`);
            if (partCard && !partCard.classList.contains('deleted')) {
                const qtyInput = partCard.querySelector('input.piece-input');
                if (qtyInput) {
                    const current = parseInt(qtyInput.value || qtyInput.placeholder || '1') || 1;
                    qtyInput.value = current + 1;
                    updateCostForPart(partNumber);
                    updateTotalCost();
                }
            }
        }

        function decreasePieceCount(partNumber) {
            decreasePieceCountBy(partNumber, 1);
        }

        function decreasePieceCountBy(partNumber, amount) {
            const partCard = document.querySelector(`.part-card[data-part="${partNumber}"]`);
            if (partCard && !partCard.classList.contains('deleted')) {
                const qtyInput = partCard.querySelector('input.piece-input');
                if (qtyInput) {
                    const current = parseInt(qtyInput.value || qtyInput.placeholder || '1') || 1;
                    const next = Math.max(1, current - amount);
                    qtyInput.value = next;
                    updateCostForPart(partNumber);
                    updateTotalCost();
                }
            }
        }

        function increasePieceCountBy(partNumber, amount) {
            const partCard = document.querySelector(`.part-card[data-part="${partNumber}"]`);
            if (partCard && !partCard.classList.contains('deleted')) {
                const qtyInput = partCard.querySelector('input.piece-input');
                if (qtyInput) {
                    const current = parseInt(qtyInput.value || qtyInput.placeholder || '1') || 1;
                    qtyInput.value = current + amount;
                    updateCostForPart(partNumber);
                    updateTotalCost();
                }
            }
        }

        function deletePart(partNumber) {
            if (confirm('Are you sure you want to delete this part?')) {
                const partCard = document.querySelector(`.part-card[data-part="${partNumber}"]`);
                if (partCard) {
                    partCard.classList.add('deleted');
                    const deleteBtn = partCard.querySelector('.delete-btn');
                    const revokeBtn = partCard.querySelector('.revoke-btn');
                    if (deleteBtn) deleteBtn.style.display = 'none';
                    if (revokeBtn) revokeBtn.style.display = 'inline-block';
                    updateTotalCost();
                }
            }
        }

        function revokePart(partNumber) {
            if (confirm('Are you sure you want to restore this part?')) {
                const partCard = document.querySelector(`.part-card[data-part="${partNumber}"]`);
                if (partCard) {
                    partCard.classList.remove('deleted');
                    const deleteBtn = partCard.querySelector('.delete-btn');
                    const revokeBtn = partCard.querySelector('.revoke-btn');
                    if (deleteBtn) deleteBtn.style.display = 'inline-block';
                    if (revokeBtn) revokeBtn.style.display = 'none';
                    updateTotalCost();
                }
            }
        }

        function updateCostForPart(partNumber) {
            const partCard = document.querySelector(`.part-card[data-part="${partNumber}"]`);
            if (partCard) {
                const qtyInput = partCard.querySelector('input.piece-input');
                const qty = parseInt(qtyInput && (qtyInput.value || qtyInput.placeholder) || '1') || 1;
                const unitCostSpan = partCard.querySelector('.unit-cost');
                const totalCostSpan = partCard.querySelector('.total-cost');
                const costData = (window.currentData.part_costs || []).find(pc => pc.part_number === parseInt(partNumber));
                if (costData && costData.cost_data && typeof costData.cost_data.total_cost === 'number') {
                    const unitCost = costData.cost_data.total_cost;
                    const totalCost = unitCost * qty;
                    if (unitCostSpan) {
                        unitCostSpan.textContent = `Unit: $${unitCost.toFixed(2)}`;
                        if (partCard.classList.contains('deleted')) {
                            unitCostSpan.classList.add('deleted');
                        } else {
                            unitCostSpan.classList.remove('deleted');
                        }
                    }
                    if (totalCostSpan) {
                        totalCostSpan.textContent = `Total: $${totalCost.toFixed(2)}`;
                        if (partCard.classList.contains('deleted')) {
                            totalCostSpan.classList.add('deleted');
                        } else {
                            totalCostSpan.classList.remove('deleted');
                        }
                    }
                }
            }
        }

        function updateTotalCost() {
            let laserCuttingCost = 0;
            document.querySelectorAll('.part-card').forEach(card => {
                if (!card.classList.contains('deleted')) {
                    const qtyInput = card.querySelector('input.piece-input');
                    const pieceCount = parseInt(qtyInput && (qtyInput.value || qtyInput.placeholder) || '1') || 1;
                    const partNumber = parseInt(card.dataset.part);
                    // Use a deduped view to avoid counting the same part twice
                    const list = Array.from(new Map((window.currentData.part_costs || []).map(pc => [pc.part_number, pc])).values());
                    const costData = list.find(pc => pc.part_number === partNumber);
                    
                    // Skip parts with calculation errors
                    if (costData && costData.calculation_error) {
                        console.log(`Skipping part ${partNumber} due to calculation error: ${costData.calculation_error}`);
                        return;
                    }
                    
                    if (costData && costData.cost_data && typeof costData.cost_data.total_cost === 'number') {
                        laserCuttingCost += costData.cost_data.total_cost * pieceCount;
                    }
                }
            });
            
            // Calculate external services total directly
            let externalServicesTotal = 0;
            document.querySelectorAll('.service-checkbox-input:checked').forEach(checkbox => {
                const serviceItem = checkbox.closest('.service-item');
                const quantityInput = serviceItem.querySelector('.service-quantity');
                const priceInput = serviceItem.querySelector('.service-price');
                
                const quantity = parseFloat(quantityInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                externalServicesTotal += quantity * price;
            });
            
            // Calculate totals
            const subtotalVatExcluded = laserCuttingCost + externalServicesTotal;
            const vatAmount = subtotalVatExcluded * 0.11;
            const totalCost = subtotalVatExcluded + vatAmount;
            
            // Debug log suppressed
            
            // Count excluded parts due to calculation errors
            let excludedPartsCount = 0;
            if (window.currentData && window.currentData.part_costs) {
                excludedPartsCount = window.currentData.part_costs.filter(pc => pc.calculation_error).length;
            }
            
            // Update the cost breakdown display
            const laserCuttingCostEl = document.getElementById('laserCuttingCost');
            const subtotalVatExcludedEl = document.getElementById('subtotalVatExcluded');
            const vatAmountEl = document.getElementById('vatAmount');
            const totalCostEl = document.getElementById('totalCost');
            
            if (laserCuttingCostEl) laserCuttingCostEl.textContent = `$${laserCuttingCost.toFixed(2)}`;
            if (subtotalVatExcludedEl) subtotalVatExcludedEl.textContent = `$${subtotalVatExcluded.toFixed(2)}`;
            if (vatAmountEl) vatAmountEl.textContent = `$${vatAmount.toFixed(2)}`;
            if (totalCostEl) totalCostEl.textContent = `$${totalCost.toFixed(2)}`;
            
            // Update excluded parts note if any parts were excluded
            const excludedPartsNote = document.getElementById('excludedPartsNote');
            const excludedPartsNote2 = document.getElementById('excludedPartsNote2');
            const excludedPartsCountEl = document.getElementById('excludedPartsCount');
            const excludedPartsCountEl2 = document.getElementById('excludedPartsCount2');
            
            if (excludedPartsCount > 0) {
                if (excludedPartsNote) {
                    excludedPartsNote.style.display = 'flex';
                    if (excludedPartsCountEl) excludedPartsCountEl.textContent = `${excludedPartsCount} part(s)`;
                }
                if (excludedPartsNote2) {
                    excludedPartsNote2.style.display = 'flex';
                    if (excludedPartsCountEl2) excludedPartsCountEl2.textContent = `${excludedPartsCount} part(s)`;
                }
            } else {
                if (excludedPartsNote) excludedPartsNote.style.display = 'none';
                if (excludedPartsNote2) excludedPartsNote2.style.display = 'none';
            }
            
            // Also update the external services total display in the services section
            const externalServicesTotalEl = document.getElementById('externalServicesTotal');
            if (externalServicesTotalEl) externalServicesTotalEl.textContent = `$${externalServicesTotal.toFixed(2)}`;
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
        }

        function showWarning(message) {
            // Use success message for warnings since we don't have a dedicated warning element
            successMessage.textContent = `⚠️ ${message}`;
            successMessage.style.display = 'block';
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 8000);
        }

        function hideMessages() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }

        // PDF Generation functionality
        async function generatePDF() {
            try {
                // Check if we have current data
                if (!window.currentData) {
                    throw new Error('No quote data available. Please upload a DXF file first.');
                }

                // Show the modal
                document.getElementById('pdfModal').style.display = 'block';

            } catch (error) {
                console.error('Error showing PDF modal:', error);
                showError(`Failed to show PDF form: ${error.message}`);
            }
        }

        // Handle form submission
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date automatically
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('quotationDate').value = today;
            
            document.getElementById('pdfForm').addEventListener('submit', async function(event) {
                event.preventDefault();

                const pdfBtn = document.querySelector('.pdf-btn');
                if (pdfBtn) {
                    pdfBtn.disabled = true;
                    pdfBtn.textContent = '🔄 Generating PDF...';
                }

                try {
                    // Start a job for PDF generation progress
                    let jobId = null;
                    try {
                        const r = await fetch('/api/progress/start', { method: 'POST' });
                        const j = await r.json();
                        jobId = j.job_id;
                    } catch {}

                    // Use dedicated PDF progress bar below the Generate PDF button
                    const progressContainer = document.getElementById('pdfProgressContainer');
                    const progressBar = document.getElementById('pdfProgressBar');
                    const progressLabel = document.getElementById('pdfProgressLabel');
                    let pollTimer = null;
                    if (jobId && progressContainer && progressBar && progressLabel) {
                        progressContainer.style.display = 'block';
                        progressBar.style.width = '0%';
                        progressLabel.textContent = '0%';
                        const poll = async () => {
                            try {
                                const res = await fetch(`/api/progress/${jobId}`);
                                if (res.ok) {
                                    const info = await res.json();
                                    const pct = Math.max(0, Math.min(100, parseInt(info.percent || 0)));
                                    progressBar.style.width = pct + '%';
                                    progressLabel.textContent = `${pct}%${info.message ? ' - ' + info.message : ''}`;
                                    if (info.status === 'done' || info.status === 'error') {
                                        clearInterval(pollTimer);
                                    }
                                }
                            } catch {}
                        };
                        pollTimer = setInterval(poll, 1000); // Reduced frequency from 500ms to 1000ms
                        poll();
                    }
                    const formData = new FormData(this);
                    const userData = Object.fromEntries(formData.entries());

                    // Get external services data
                    const externalServicesData = getExternalServicesData();
                    
                    // Get part quantities from the frontend
                    const partQuantities = getPartQuantities();
                    
                    // Determine deleted parts (cards marked as deleted in the UI)
                    const deletedSet = new Set(Array.from(document.querySelectorAll('.part-card.deleted'))
                        .map(card => parseInt(card.getAttribute('data-part')))
                        .filter(n => !isNaN(n)));

                    // Update part_costs with quantities from frontend and drop deleted parts
                    const updatedPartCosts = (window.currentData.part_costs || [])
                        .filter(partCost => !deletedSet.has(partCost.part_number))
                        .map(partCost => {
                        const partNumber = partCost.part_number;
                        const frontendQuantity = partQuantities[partNumber] || 1;
                        return {
                            ...partCost,
                            object_parts_count: frontendQuantity, // Use frontend quantity instead of calculated count
                            cost_data: {
                                ...partCost.cost_data,
                                // Update total cost based on quantity
                                total_cost: partCost.cost_data.total_cost * frontendQuantity
                            }
                        };
                    });
                    
                    // Combine user data with current quote data
                    const quoteData = {
                        ...window.currentData,
                        ...userData,
                        // Filter images to exclude deleted parts as well
                        part_images: (window.currentData.part_images || []).filter(img => !deletedSet.has(img.part_number)),
                        part_costs: updatedPartCosts,
                        stats: window.currentData.stats || {},
                        external_services_form_data: externalServicesData
                    };

                    // Call the PDF generation endpoint
                    const response = await fetch(`/api/pdf/${userData.quotationNumber}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/pdf'
                        },
                        body: JSON.stringify(jobId ? { ...quoteData, job_id: jobId } : quoteData)
                    });

                    if (!response.ok) {
                        throw new Error(`Failed to generate PDF: ${response.statusText}`);
                    }

                    // Get the PDF blob
                    const pdfBlob = await response.blob();

                    // Get the original filename for PDF naming
                    const originalFileName = window.currentData.original_filename || 'quote';
                    const fileNameWithoutExt = originalFileName.replace(/\.[^/.]+$/, "");

                    // Create download link
                    const url = window.URL.createObjectURL(pdfBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `${fileNameWithoutExt}_${userData.quotationNumber}.pdf`;
                    
                    // Trigger download
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Clean up
                    window.URL.revokeObjectURL(url);

                    // Finish/Hide progress bar
                    if (jobId && progressContainer) {
                        if (progressBar) progressBar.style.width = '100%';
                        if (progressLabel) progressLabel.textContent = '100% - PDF Ready';
                        setTimeout(() => { progressContainer.style.display = 'none'; }, 1200);
                    }

                    // Re-enable the button
                    if (pdfBtn) {
                        pdfBtn.disabled = false;
                        pdfBtn.textContent = '📄 Create PDF Quote';
                    }

                    showSuccess('PDF quote generated successfully!');
                    document.getElementById('pdfModal').style.display = 'none'; // Hide modal on success

                } catch (error) {
                    console.error('Error generating PDF:', error);
                    const pdfBtn = document.querySelector('.pdf-btn');
                    if (pdfBtn) {
                        pdfBtn.disabled = false;
                        pdfBtn.textContent = '📄 Create PDF Quote';
                    }
                    // Hide progress bar on error
                    const progressContainer = document.getElementById('pdfProgressContainer');
                    if (progressContainer) progressContainer.style.display = 'none';
                    showError(`Failed to generate PDF: ${error.message}`);
                }
            });
        });

        function closePdfModal() {
            document.getElementById('pdfModal').style.display = 'none';
        }

        // Function to get placeholder fields (for validation)
        async function getPlaceholderFields() {
            try {
                const response = await fetch('/api/placeholders');
                if (!response.ok) {
                    throw new Error('Failed to fetch placeholder fields');
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching placeholder fields:', error);
                return {};
            }
        }

        // Nest & Metrics handler
        async function nestAndMetrics() {
            try {
                const fileInput = document.getElementById('fileInput');
                const multiInput = document.getElementById('multiFilesInput');
                let file = null;
                if (fileInput && fileInput.files && fileInput.files.length > 0) {
                    file = fileInput.files[0];
                } else if (multiInput && multiInput.files && multiInput.files.length > 0) {
                    file = multiInput.files[0];
                } else if (window.__multiFiles && window.__multiFiles.size > 0) {
                    file = Array.from(window.__multiFiles)[0];
                }
                if (!file) {
                    showError('Please select a DXF file first.');
                    return;
                }

                // Nesting functionality removed for deployment

                const fd = new FormData();
                fd.append('dxf', file, file.name);
                fd.append('quantities_from_text', JSON.stringify({ default: 1 }));
                fd.append('boards', JSON.stringify([]));
                fd.append('leftover_threshold', '0.2');
                fd.append('stats_only', 'true');

                const resp = await fetch('/api/nest-and-metrics', { method: 'POST', body: fd });
                if (!resp.ok) {
                    const t = await resp.text();
                    throw new Error(t || 'Nest API failed');
                }
                const data = await resp.json();
                showSuccess(`Scrap calculation complete. Scrap factor: ${Number(data.scrap_factor).toFixed(4)}`);
            } catch (err) {
                console.error(err);
                showError(`Failed to nest and compute metrics: ${err.message || err}`);
            } finally {
                const btn = document.getElementById('nestMetricsBtn');
                if (btn) { btn.disabled = false; btn.textContent = 'Nest & Calculate Scrap'; }
            }
        }

        const nestBtn = document.getElementById('nestMetricsBtn');
        if (nestBtn) nestBtn.addEventListener('click', nestAndMetrics);

        // Final quote calculation using the last analyzed DXF
        async function calculateQuote() {
            try {
                const calcBtn = document.getElementById('calcQuoteBtn');
                if (calcBtn) { calcBtn.disabled = true; calcBtn.textContent = 'Calculating…'; }
                if (!window.__lastFile) {
                    showError('Please upload and analyze a DXF first.');
                    if (calcBtn) { calcBtn.disabled = false; calcBtn.textContent = 'Calculate Quote'; }
                    return;
                }

                // Show processing UI
                const processing = document.getElementById('processing');
                if (processing) processing.style.display = 'block';
                hideMessages();

                // Start progress
                let jobId = null;
                try {
                    const r = await fetch('/api/progress/start', { method: 'POST' });
                    const j = await r.json();
                    jobId = j.job_id;
                } catch {}

                const progressContainer = document.getElementById('progressContainer');
                const progressBar = document.getElementById('progressBar');
                const progressLabel = document.getElementById('progressLabel');
                let pollTimer = null;
                if (jobId && progressContainer && progressBar && progressLabel) {
                    progressContainer.style.display = 'block';
                    progressBar.style.width = '0%';
                    progressLabel.textContent = '0%';
                    const poll = async () => {
                        try {
                            const res = await fetch(`/api/progress/${jobId}`);
                            if (res.ok) {
                                const info = await res.json();
                                const pct = Math.max(0, Math.min(100, parseInt(info.percent || 0)));
                                progressBar.style.width = pct + '%';
                                progressLabel.textContent = `${pct}%${info.message ? ' - ' + info.message : ''}`;
                                if (info.status === 'done' || info.status === 'error') {
                                    clearInterval(pollTimer);
                                }
                            }
                        } catch {}
                    };
                    pollTimer = setInterval(poll, 1000); // Reduced frequency from 500ms to 1000ms
                    poll();
                }

                // Build form data from current selections (fallback to last upload params)
                const file = window.__lastFile;
                const formData = new FormData();
                formData.append('file', file);
                // Attach material overrides from Materials Used table so backend can override DB values
                try {
                    const overrides = window.materialOverrides || {};
                    formData.append('material_overrides', JSON.stringify(overrides));
                } catch {}
                
                // Use updated part_labels if available (from material selection popup), otherwise fallback to form dropdowns
                const currentData = window.currentData;
                if (currentData && currentData.part_labels) {
                    // Send the updated part_labels data to backend for cost calculation
                    formData.append('part_labels', JSON.stringify(currentData.part_labels));
                } else {
                    // Fallback to form dropdowns
                    const last = window.__lastUploadParams || {};
                    const materialType = document.getElementById('materialTypeSelect')?.value || last.materialType || '';
                    const thickness = document.getElementById('thicknessSelect')?.value || last.thickness || '';
                    const grade = document.getElementById('gradeSelect')?.value || last.grade || '';
                    const finish = document.getElementById('finishSelect')?.value || last.finish || '';
                    formData.append('material_name', materialType);
                    formData.append('thickness', thickness);
                    formData.append('grade', grade);
                    formData.append('finish', finish);
                }
                
                const scrapFactor = document.getElementById('scrapFactor')?.value || '1.20';
                formData.append('scrap_factor', scrapFactor);
                if (jobId) formData.append('job_id', jobId);

                const resp = await fetch('/upload', { method: 'POST', body: formData });
                const data = await resp.json();

                if (processing) processing.style.display = 'none';
                if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
                if (jobId && progressContainer && progressBar && progressLabel) {
                    progressBar.style.width = '100%';
                    progressLabel.textContent = '100% - Completed';
                    setTimeout(() => { progressContainer.style.display = 'none'; }, 1200);
                }

                if (!resp.ok || !data.success) {
                    showError(data.error || 'Failed to calculate quote.');
                    const calcBtn2 = document.getElementById('calcQuoteBtn');
                    if (calcBtn2) { calcBtn2.disabled = false; calcBtn2.textContent = 'Calculate Quote'; }
                    return;
                }
                showResults(data);
                const successMessage = document.getElementById('successMessage');
                if (successMessage) {
                    successMessage.textContent = 'Quote calculated successfully. Cost breakdown is now displayed for all parts.';
                    successMessage.style.display = 'block';
                    setTimeout(() => { successMessage.style.display = 'none'; }, 4000);
                }
                const calcBtn3 = document.getElementById('calcQuoteBtn');
                if (calcBtn3) { calcBtn3.disabled = false; calcBtn3.textContent = 'Calculate Quote'; }
            } catch (e) {
                const processing = document.getElementById('processing');
                if (processing) processing.style.display = 'none';
                const progressContainer = document.getElementById('progressContainer');
                if (progressContainer) progressContainer.style.display = 'none';
                showError('Network error: ' + (e.message || e));
                const calcBtn = document.getElementById('calcQuoteBtn');
                if (calcBtn) { calcBtn.disabled = false; calcBtn.textContent = 'Calculate Quote'; }
            }
        }
    </script>


</body>
</html> 